<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handball Statistik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active { border-bottom-color: #4f46e5; color: #4f46e5; }
        .detail-tab-active { background-color: #eef2ff; color: #4f46e5; }
        .view { display: none; }
        .view-active { display: block; }
        .detail-view-content { display: none; }
        .detail-view-content-active { display: block; }
        .clickable-player { cursor: pointer; text-decoration: underline; text-decoration-color: #a5b4fc; }
        .clickable-player:hover { text-decoration-color: #4f46e5; }
        #connection-status-container { cursor: pointer; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .view-active { animation: fadeIn 0.3s ease-in-out; }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal.flex { display: flex; }
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            z-index: 110;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
        }
        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .notification.bg-success { background-color: #28a745; }
        .notification.bg-error { background-color: #dc3545; }
        .notification.bg-info { background-color: #17a2b8; }

        .status-dot-connected { background-color: #28a745; }
        .status-dot-disconnected { background-color: #dc3545; }
        .status-dot-checking { background-color: #ffc107; }
        .status-dot-unknown { background-color: #6c757d; }
        
        .player-card {
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .player-card:hover {
            border-color: #a5b4fc;
            transform: translateY(-2px);
        }
        .player-card.selected {
            border-color: #4f46e5;
            background-color: #eef2ff;
            transform: scale(1.05);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .sub-tab-active { 
            border-bottom-color: #4f46e5; /* indigo-600 */
            color: #4f46e5; 
        }
        .sub-view { display: none; }
        .sub-view-active { display: block; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 max-w-7xl">
        <header class="bg-white rounded-xl shadow-md p-4 sm:p-6 mb-6 flex justify-between items-center">
            <div class="flex items-baseline space-x-3">
                <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-indigo-600">Handball Statistik</h1>
                <span class="text-sm font-light text-black">by Carsten</span>
            </div>
        </header>

        <div class="mb-6 border-b border-gray-200">
            <nav class="flex space-x-2 sm:space-x-4 overflow-x-auto pb-2">
                <button id="tab-archiv" class="tab-btn px-3 py-3 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-gray-300 shrink-0">Archiv & Eingabe</button>
                <button id="tab-statistik" class="tab-btn px-3 py-3 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-gray-300 shrink-0">Team-Statistiken</button>
                <button id="tab-spielauswertung" class="tab-btn px-3 py-3 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-gray-300 shrink-0">Spielauswertung</button>
                <button id="tab-spieler" class="tab-btn px-3 py-3 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-gray-300 shrink-0">Spieler-Profile</button>
                <button id="tab-h2h" class="tab-btn px-3 py-3 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-gray-300 shrink-0">H2H-Vergleich</button>
                <button id="tab-einstellungen" class="tab-btn px-3 py-3 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-gray-300 shrink-0">Einstellungen</button>
            </nav>
        </div>

        <main>
            <div id="view-eingabe" class="view">
                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                        <h2 id="eingabe-title" class="text-xl sm:text-2xl font-bold">Neues Spiel hinzufügen</h2>
                        <button id="process-and-save-btn" class="w-full sm:w-auto bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105 shrink-0">
                            <span class="sm:hidden">Analysieren & Speichern</span>
                            <span class="hidden sm:inline">Spiel analysieren & hinzufügen</span>
                        </button>
                    </div>
                    <p class="mb-4 text-gray-600 text-sm sm:text-base">Kopiere den kompletten "Presseinformation - lang" Text aus handball4all hier hinein.</p>
                    <textarea id="game-data-input" rows="15" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Hier die Spieldaten einfügen..."></textarea>
                    <button id="cancel-edit-btn" class="mt-4 w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition">
                        Abbrechen
                    </button>
                    <div id="input-status" class="mt-4 text-center"></div>
                </div>
            </div>

            <div id="view-archiv" class="view">
                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                    <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4 gap-4">
                        <h2 class="text-2xl font-bold shrink-0">Archivierte Spiele</h2>
                        <button id="show-eingabe-view-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-transform transform hover:scale-105 w-full sm:w-auto">
                            Neues Spiel
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                        <div>
                            <label for="archive-search-input" class="block text-sm font-medium text-gray-700">Team-Suche (Hauptfilter)</label>
                            <input type="text" id="archive-search-input" placeholder="Team eingeben..." class="mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 w-full">
                        </div>
                        <div>
                            <label for="archive-filter-location" class="block text-sm font-medium text-gray-700">Spielort</label>
                            <select id="archive-filter-location" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm">
                                <option value="all">Alle</option>
                                <option value="home">Nur Heimspiele</option>
                                <option value="away">Nur Auswärtsspiele</option>
                            </select>
                        </div>
                        <div>
                            <label for="archive-filter-opponent" class="block text-sm font-medium text-gray-700">Gegner</label>
                            <select id="archive-filter-opponent" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm" disabled>
                                <option value="all">Alle Gegner</option>
                            </select>
                        </div>
                    </div>

                    <div id="import-status" class="my-4 text-center"></div>
                    <p class="text-sm text-gray-500 mb-4">Klicke auf ein Spiel, um die Auswertungen anzuzeigen.</p>
                    <div id="game-archive-list" class="space-y-2"></div>
                </div>
            </div>
            
            <div id="view-spielauswertung" class="view">
                <div id="spielauswertung-placeholder" class="text-center p-8 bg-white rounded-lg shadow-md">
                    <p class="text-gray-500">Bitte wähle zuerst ein Spiel aus dem Archiv aus, um die Details anzuzeigen.</p>
                </div>
                <div id="spielauswertung-content" style="display: none;">
                    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                        <div id="game-detail-header" class="flex justify-between items-start mb-4 flex-wrap gap-4">
                            <div>
                                <h2 id="game-detail-title" class="text-xl sm:text-2xl font-bold">Spieldetails</h2>
                                <p id="game-detail-subtitle" class="text-gray-600"></p>
                            </div>
                        </div>

                        <div class="my-6 p-4 bg-gray-50 rounded-lg flex items-center justify-between gap-2 sm:gap-4">
                            <button id="prev-game-btn" class="p-2 rounded-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                            </button>
                            <div class="flex-1 min-w-0">
                                <select id="game-nav-select" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm truncate"></select>
                            </div>
                            <button id="next-game-btn" class="p-2 rounded-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>

                        <div class="border-b border-gray-200 mb-6">
                            <nav class="-mb-px flex space-x-4 overflow-x-auto" aria-label="Tabs">
                                <button id="detail-tab-tabular" class="detail-tab-btn whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm">Tabellarisch</button>
                                <button id="detail-tab-graphical" class="detail-tab-btn whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm">Grafisch</button>
                            </nav>
                        </div>

                        <div id="detail-content-graphical" class="detail-view-content">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div class="lg:col-span-2 space-y-6">
                                    <div class="p-2 sm:p-4 bg-gray-50 rounded-lg"><canvas id="score-chart"></canvas></div>
                                    <div class="p-2 sm:p-4 bg-gray-50 rounded-lg"><canvas id="scoring-run-chart"></canvas></div>
                                </div>
                                <div class="p-4 bg-gray-50 rounded-lg">
                                    <h3 class="font-bold mb-2 text-gray-700">Torschützen</h3>
                                    <div id="player-goal-list" class="space-y-1" style="max-height: 70vh; overflow-y: auto;"></div>
                                </div>
                            </div>
                        </div>

                        <div id="detail-content-tabular" class="detail-view-content">
                             <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 flex-wrap gap-4">
                                <div><h2 class="text-xl sm:text-2xl font-bold">Tabellarische Auswertung</h2></div>
                                <button id="correct-names-btn" class="w-full sm:w-auto bg-purple-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-600 transition">Namen korrigieren</button>
                            </div>
                            <div id="tabular-content-container" class="space-y-8"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-statistik" class="view">
                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Team-Statistiken</h2>
                    <div class="mb-6">
                        <label for="team-select" class="block text-sm font-medium text-gray-700 mb-2">Team für die Analyse auswählen:</label>
                        <select id="team-select" class="w-full md:w-1/2 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                    <div id="stats-container" class="space-y-8">
                        <p id="stats-placeholder" class="text-gray-500">Bitte ein Team auswählen, um die Statistiken anzuzeigen.</p>
                    </div>
                </div>
            </div>

            <div id="view-spieler" class="view">
                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Spieler-Profile</h2>
                    
                    <div class="mb-6">
                        <div class="flex flex-col sm:flex-row gap-4 mb-4">
                            <div class="flex-grow">
                                <label for="player-team-filter" class="block text-sm font-medium text-gray-700 mb-2">Nach Mannschaft filtern:</label>
                                <select id="player-team-filter" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></select>
                            </div>
                            <div class="flex-grow">
                                <label for="player-search-input" class="block text-sm font-medium text-gray-700 mb-2">Spieler suchen:</label>
                                <input type="text" id="player-search-input" placeholder="Name eingeben..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>
                        <div id="player-card-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 max-h-96 overflow-y-auto p-2 bg-gray-50 rounded-lg">
                        </div>
                    </div>

                    <div id="player-profile-container" class="space-y-8">
                        <p id="player-profile-placeholder" class="text-gray-500">Bitte einen Spieler auswählen, um das Profil anzuzeigen.</p>
                    </div>
                </div>
            </div>

            <div id="view-h2h" class="view">
                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Head-to-Head (H2H) Vergleich</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div class="md:col-span-1">
                            <label for="h2h-team1-select" class="block text-sm font-medium text-gray-700 mb-1">Team 1</label>
                            <select id="h2h-team1-select" class="w-full p-2 border border-gray-300 rounded-lg"></select>
                        </div>
                        <div class="md:col-span-1">
                            <label for="h2h-team2-select" class="block text-sm font-medium text-gray-700 mb-1">Team 2</label>
                            <select id="h2h-team2-select" class="w-full p-2 border border-gray-300 rounded-lg"></select>
                        </div>
                        <button id="h2h-compare-btn" class="w-full md:w-auto bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Vergleichen</button>
                    </div>
                    <div id="h2h-results-container" class="mt-8 space-y-6"></div>
                </div>
            </div>

            <div id="view-einstellungen" class="view">
                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                            <button id="subtab-kader" class="sub-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                Kaderverwaltung
                            </button>
                            <button id="subtab-daten" class="sub-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                Datenverwaltung
                            </button>
                        </nav>
                    </div>
                    <div class="pt-6">
                        <div id="subview-kader" class="sub-view">
                            <div id="custom-roster-management-container"></div>
                        </div>
                        <div id="subview-daten" class="sub-view">
                            <h3 class="text-xl font-bold mb-4 text-indigo-700">Gesamtdaten-Verwaltung</h3>
                            <p class="text-sm text-gray-600 mb-4">
                                Hier kannst du <strong>alle</strong> Daten (Spiele, Kader, Einstellungen) als eine einzige Sicherungsdatei exportieren oder aus einer solchen Datei wiederherstellen.
                                <strong class="text-red-600">Achtung:</strong> Der Import überschreibt alle vorhandenen Daten!
                            </p>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <button id="import-all-btn" class="flex-1 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition">
                                    Alles importieren (.json)
                                </button>
                                <button id="export-all-btn" class="flex-1 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition">
                                    Alles exportieren (.json)
                                </button>
                            </div>
                            <div id="data-import-status" class="my-4 text-center"></div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
        
        <footer class="text-center text-sm text-gray-500 mt-12 pb-4">
            <p>Handball Statistik by Carsten | Version <span id="app-version"></span></p>
            <div id="connection-status-container" class="inline-flex items-center justify-center space-x-2 mt-2 hover:bg-gray-200 p-2 rounded-md transition">
                <div id="connection-status-dot" class="w-3 h-3 rounded-full status-dot-unknown transition-colors"></div>
                <span id="connection-status-text" class="text-sm text-gray-600">Verbindungsstatus unbekannt</span>
            </div>
        </footer>
    </div>

    <div id="name-correction-modal" class="modal">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full mx-4">
            <h3 class="text-lg font-bold mb-4">Spielernamen korrigieren</h3>
            <div id="name-correction-list" class="space-y-2 max-h-96 overflow-y-auto mb-6"></div>
            <div class="flex flex-col sm:flex-row justify-between space-y-2 sm:space-y-0 sm:space-x-4">
                <button id="name-correction-revert-ui" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">Originale wiederherstellen</button>
                <div class="flex justify-end space-x-4">
                    <button id="name-correction-cancel" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700">Abbrechen</button>
                    <button id="name-correction-save" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Speichern</button>
                </div>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="modal">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full mx-4 text-center">
            <h3 class="text-xl font-bold mb-4">Bestätigung</h3>
            <p id="confirmation-message" class="text-gray-600 mb-6">Möchten Sie diese Aktion wirklich durchführen?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">Abbrechen</button>
                <button id="confirm-ok-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Bestätigen</button>
            </div>
        </div>
    </div>

    <div id="custom-roster-modal" class="modal">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <h3 id="custom-roster-modal-title" class="text-lg font-bold mb-4">Kader bearbeiten</h3>
            <div class="mb-4">
                <label for="custom-roster-name-input" class="block text-sm font-medium text-gray-700">Kadername</label>
                <input type="text" id="custom-roster-name-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div id="custom-roster-editor" class="space-y-2 max-h-80 overflow-y-auto mb-6 p-2 border rounded-md"></div>
            <button id="add-custom-roster-player-btn" class="mb-4 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 text-sm">Spieler hinzufügen</button>
            <div class="flex justify-end space-x-4">
                <button id="custom-roster-cancel-btn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700">Abbrechen</button>
                <button id="custom-roster-save-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Speichern</button>
            </div>
        </div>
    </div>

    <div id="connection-details-modal" class="modal">
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl max-w-lg w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Verbindungsdetails</h3>
                <button id="connection-modal-close-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="space-y-3 text-sm">
                <div class="flex justify-between border-b pb-2">
                    <span class="font-semibold text-gray-600">Status:</span>
                    <span id="modal-connection-status" class="font-mono">-</span>
                </div>
                <div class="flex justify-between border-b pb-2">
                    <span class="font-semibold text-gray-600">App ID:</span>
                    <span id="modal-app-id" class="font-mono break-all text-right">-</span>
                </div>
                <div class="flex justify-between border-b pb-2">
                    <span class="font-semibold text-gray-600">User ID:</span>
                    <span id="modal-user-id" class="font-mono break-all text-right">-</span>
                </div>
                 <div class="flex justify-between border-b pb-2">
                    <span class="font-semibold text-gray-600">Datenbank-Pfad:</span>
                    <span id="modal-db-path" class="font-mono break-all text-right">-</span>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="import-all-file-input" class="hidden" accept=".json">
    <input type="file" id="import-roster-archive-input" class="hidden" accept=".json">

    <div id="notification" class="notification"></div>

    <script type="module">
        // Firebase Modular SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        
        // --- CONFIG & INITIALIZATION ---
        const APP_VERSION = "4.15.1-filter-fix";
        
        // Global state variables
        let allGames = [];
        let allCustomRosters = [];
        let defaultRosterId = null;
        let currentlyLoadedGameId = null;
        let currentlyEditingGameId = null;
        let scoreChart = null;
        let scoringRunChart = null;
        let playerProfileChart = null;
        let selectedPlayers = [];
        let selectedPlayerName = null;
        let currentlyEditingCustomRosterId = null;

        // --- DOM ELEMENTS ---
        let views, tabs, gameDataInput, processBtn, cancelBtn, eingabeTitle, inputStatus, gameArchiveList, archiveSearchInput, showEingabeBtn, teamSelect, statsContainer, statsPlaceholder, appVersionDisplay, spielauswertungPlaceholder, spielauswertungContent, gameDetailTitle, gameDetailSubtitle, scoreChartCanvas, scoringRunChartCanvas, playerGoalList, tabularContentContainer, exportAllBtn, importAllBtn, importAllFileInput, dataImportStatus, correctNamesBtn, nameCorrectionModal, nameCorrectionList, nameCorrectionSaveBtn, nameCorrectionCancelBtn, nameCorrectionRevertUIBtn, confirmationModal, confirmationMessage, confirmOkBtn, confirmCancelBtn, notificationElement, connectionStatusContainer, connectionStatusDot, connectionStatusText, detailTabGraphical, detailTabTabular, detailContentGraphical, detailContentTabular, gameNavSelect, prevGameBtn, nextGameBtn, playerProfileContainer, playerProfilePlaceholder, playerCardContainer, playerSearchInput, playerTeamFilter, h2hTeam1Select, h2hTeam2Select, h2hCompareBtn, connectionDetailsModal, connectionModalCloseBtn, modalConnectionStatus, modalAppId, modalUserId, modalDbPath, customRosterManagementContainer, customRosterModal, customRosterModalTitle, customRosterNameInput, customRosterEditor, addCustomRosterPlayerBtn, customRosterSaveBtn, customRosterCancelBtn, importRosterArchiveInput, archiveFilterLocation, archiveFilterOpponent, settingsView;

        // --- Game Navigation Functions ---
        function populateGameNavigation(gameId) {
            gameNavSelect.innerHTML = '';
            allGames.forEach(game => {
                const option = document.createElement('option');
                option.value = game.id;
                option.textContent = `${game.date} - ${getCorrectedName(game, game.homeTeam)} vs ${getCorrectedName(game, game.guestTeam)}`;
                option.selected = game.id === gameId;
                gameNavSelect.appendChild(option);
            });

            const currentIndex = allGames.findIndex(g => g.id === gameId);
            prevGameBtn.disabled = currentIndex === 0;
            nextGameBtn.disabled = currentIndex === allGames.length - 1;
        }

        function navigateToPreviousGame() {
            const currentIndex = allGames.findIndex(g => g.id === currentlyLoadedGameId);
            if (currentIndex > 0) {
                renderGameDetail(allGames[currentIndex - 1].id, false);
            }
        }

        function navigateToNextGame() {
            const currentIndex = allGames.findIndex(g => g.id === currentlyLoadedGameId);
            if (currentIndex < allGames.length - 1) {
                renderGameDetail(allGames[currentIndex + 1].id, false);
            }
        }
        
        // --- UI & VIEW MANAGEMENT ---
        function setupUI() {
            // DOM Element Initialization
            views = {
                eingabe: document.getElementById('view-eingabe'), 
                archiv: document.getElementById('view-archiv'),
                statistik: document.getElementById('view-statistik'), 
                spielauswertung: document.getElementById('view-spielauswertung'),
                spieler: document.getElementById('view-spieler'),
                h2h: document.getElementById('view-h2h'),
                einstellungen: document.getElementById('view-einstellungen'),
            };
            tabs = {
                archiv: document.getElementById('tab-archiv'),
                statistik: document.getElementById('tab-statistik'),
                spielauswertung: document.getElementById('tab-spielauswertung'),
                spieler: document.getElementById('tab-spieler'),
                h2h: document.getElementById('tab-h2h'),
                einstellungen: document.getElementById('tab-einstellungen'),
            };
            gameDataInput = document.getElementById('game-data-input');
            processBtn = document.getElementById('process-and-save-btn');
            cancelBtn = document.getElementById('cancel-edit-btn');
            eingabeTitle = document.getElementById('eingabe-title');
            inputStatus = document.getElementById('input-status');
            gameArchiveList = document.getElementById('game-archive-list');
            archiveSearchInput = document.getElementById('archive-search-input');
            showEingabeBtn = document.getElementById('show-eingabe-view-btn');
            teamSelect = document.getElementById('team-select');
            statsContainer = document.getElementById('stats-container');
            statsPlaceholder = document.getElementById('stats-placeholder');
            appVersionDisplay = document.getElementById('app-version');
            spielauswertungPlaceholder = document.getElementById('spielauswertung-placeholder');
            spielauswertungContent = document.getElementById('spielauswertung-content');
            gameDetailTitle = document.getElementById('game-detail-title');
            gameDetailSubtitle = document.getElementById('game-detail-subtitle');
            scoreChartCanvas = document.getElementById('score-chart');
            scoringRunChartCanvas = document.getElementById('scoring-run-chart');
            playerGoalList = document.getElementById('player-goal-list');
            tabularContentContainer = document.getElementById('tabular-content-container');
            exportAllBtn = document.getElementById('export-all-btn');
            importAllBtn = document.getElementById('import-all-btn');
            importAllFileInput = document.getElementById('import-all-file-input');
            dataImportStatus = document.getElementById('data-import-status');
            correctNamesBtn = document.getElementById('correct-names-btn');
            nameCorrectionModal = document.getElementById('name-correction-modal');
            nameCorrectionList = document.getElementById('name-correction-list');
            nameCorrectionSaveBtn = document.getElementById('name-correction-save');
            nameCorrectionCancelBtn = document.getElementById('name-correction-cancel');
            nameCorrectionRevertUIBtn = document.getElementById('name-correction-revert-ui');
            confirmationModal = document.getElementById('confirmation-modal');
            confirmationMessage = document.getElementById('confirmation-message');
            confirmOkBtn = document.getElementById('confirm-ok-btn');
            confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            notificationElement = document.getElementById('notification');
            connectionStatusContainer = document.getElementById('connection-status-container');
            connectionStatusDot = document.getElementById('connection-status-dot');
            connectionStatusText = document.getElementById('connection-status-text');
            detailTabGraphical = document.getElementById('detail-tab-graphical');
            detailTabTabular = document.getElementById('detail-tab-tabular');
            detailContentGraphical = document.getElementById('detail-content-graphical');
            detailContentTabular = document.getElementById('detail-content-tabular');
            gameNavSelect = document.getElementById('game-nav-select');
            prevGameBtn = document.getElementById('prev-game-btn');
            nextGameBtn = document.getElementById('next-game-btn');
            playerProfileContainer = document.getElementById('player-profile-container');
            playerProfilePlaceholder = document.getElementById('player-profile-placeholder');
            playerCardContainer = document.getElementById('player-card-container');
            playerSearchInput = document.getElementById('player-search-input');
            playerTeamFilter = document.getElementById('player-team-filter');
            h2hTeam1Select = document.getElementById('h2h-team1-select');
            h2hTeam2Select = document.getElementById('h2h-team2-select');
            h2hCompareBtn = document.getElementById('h2h-compare-btn');
            connectionDetailsModal = document.getElementById('connection-details-modal');
            connectionModalCloseBtn = document.getElementById('connection-modal-close-btn');
            modalConnectionStatus = document.getElementById('modal-connection-status');
            modalAppId = document.getElementById('modal-app-id');
            modalUserId = document.getElementById('modal-user-id');
            modalDbPath = document.getElementById('modal-db-path');
            customRosterManagementContainer = document.getElementById('custom-roster-management-container');
            customRosterModal = document.getElementById('custom-roster-modal');
            customRosterModalTitle = document.getElementById('custom-roster-modal-title');
            customRosterNameInput = document.getElementById('custom-roster-name-input');
            customRosterEditor = document.getElementById('custom-roster-editor');
            addCustomRosterPlayerBtn = document.getElementById('add-custom-roster-player-btn');
            customRosterSaveBtn = document.getElementById('custom-roster-save-btn');
            customRosterCancelBtn = document.getElementById('custom-roster-cancel-btn');
            importRosterArchiveInput = document.getElementById('import-roster-archive-input');
            archiveFilterLocation = document.getElementById('archive-filter-location');
            archiveFilterOpponent = document.getElementById('archive-filter-opponent');
            settingsView = document.getElementById('view-einstellungen');


            // Event Listeners
            appVersionDisplay.textContent = APP_VERSION;
            Object.keys(tabs).forEach(key => {
                tabs[key].addEventListener('click', () => switchView(key));
            });
            processBtn.addEventListener('click', handleProcessAndSaveGame);
            teamSelect.addEventListener('change', renderStatistics);
            cancelBtn.addEventListener('click', () => switchView('archiv'));
            showEingabeBtn.addEventListener('click', () => {
                resetToNewEntryMode();
                switchView('eingabe');
            });
            
            exportAllBtn.addEventListener('click', exportAllData);
            importAllBtn.addEventListener('click', () => importAllFileInput.click());
            importAllFileInput.addEventListener('change', importAllData);
            correctNamesBtn.addEventListener('click', openNameCorrectionModal);
            nameCorrectionSaveBtn.addEventListener('click', saveNameCorrections);
            nameCorrectionCancelBtn.addEventListener('click', () => nameCorrectionModal.classList.remove('flex'));
            nameCorrectionRevertUIBtn.addEventListener('click', () => {
                 const inputs = nameCorrectionList.querySelectorAll('input[data-original-name]');
                 inputs.forEach(input => {
                     input.value = input.dataset.originalName;
                 });
                 showNotification('Änderungen im Formular zurückgesetzt.', 'info');
            });
            
            settingsView.addEventListener('click', (event) => {
                const subtab = event.target.closest('.sub-tab-btn');
                if (subtab) {
                    switchSettingsSubView(subtab.id.replace('subtab-', ''));
                    return;
                }
            });

            nameCorrectionList.addEventListener('change', (event) => {
                const rosterSelect = event.target.closest('.custom-roster-select');
                const playerSelect = event.target.closest('.roster-select');

                if (rosterSelect) {
                    handleCustomRosterSelectionChange(rosterSelect);
                }
                if (playerSelect) {
                    handlePlayerSelectionChange(playerSelect);
                }
            });

            document.body.addEventListener('click', (event) => {
                if(event.target.classList.contains('clickable-player')) {
                    const playerName = event.target.dataset.playerName;
                    if(playerName) {
                        renderPlayerProfile(playerName, true);
                    }
                }
            });

            gameArchiveList.addEventListener('click', (event) => {
                const deleteButton = event.target.closest('.delete-game-btn');
                const editButton = event.target.closest('.edit-game-btn');
                const gameButton = event.target.closest('.game-entry-btn');

                if (deleteButton) {
                    event.stopPropagation();
                    const gameId = deleteButton.dataset.gameId;
                    showConfirmation(`Möchtest du das Spiel wirklich löschen?`, () => deleteGame(gameId));
                } else if (editButton) {
                    event.stopPropagation();
                    const gameId = editButton.dataset.gameId;
                    startEditing(gameId);
                } else if (gameButton) {
                    const gameId = gameButton.dataset.gameId;
                    if (gameId) {
                       renderGameDetail(gameId, true);
                    }
                }
            });

            playerGoalList.addEventListener('click', (event) => {
                const playerButton = event.target.closest('.player-goal-btn');
                if (playerButton) {
                    const playerName = playerButton.dataset.playerName;
                    const game = allGames.find(g => g.id === currentlyLoadedGameId);
                    if (selectedPlayers.includes(playerName)) {
                        selectedPlayers = selectedPlayers.filter(p => p !== playerName);
                        playerButton.classList.remove('bg-indigo-500', 'text-white');
                    } else {
                        selectedPlayers.push(playerName);
                        playerButton.classList.add('bg-indigo-500', 'text-white');
                    }
                    updateChartWithSelectedPlayers(game);
                }
            });
            
            connectionStatusContainer.addEventListener('click', showConnectionDetailsModal);
            connectionModalCloseBtn.addEventListener('click', () => connectionDetailsModal.classList.remove('flex'));
            detailTabGraphical.addEventListener('click', () => switchDetailView('graphical'));
            detailTabTabular.addEventListener('click', () => switchDetailView('tabular'));
            gameNavSelect.addEventListener('change', (e) => renderGameDetail(e.target.value, false));
            prevGameBtn.addEventListener('click', navigateToPreviousGame);
            nextGameBtn.addEventListener('click', navigateToNextGame);
            archiveSearchInput.addEventListener('input', () => renderArchiveList());
            archiveFilterLocation.addEventListener('change', () => renderArchiveList());
            archiveFilterOpponent.addEventListener('change', () => renderArchiveList());
            h2hCompareBtn.addEventListener('click', renderH2hComparison);

            // Player View Listeners
            playerSearchInput.addEventListener('input', filterPlayers);
            playerTeamFilter.addEventListener('change', filterPlayers);
            playerCardContainer.addEventListener('click', (e) => {
                const card = e.target.closest('.player-card');
                if (card) {
                    const playerName = card.dataset.playerName;
                    renderPlayerProfile(playerName);
                }
            });

            // Custom Roster Modal Listeners
            customRosterSaveBtn.addEventListener('click', saveCustomRoster);
            customRosterCancelBtn.addEventListener('click', () => customRosterModal.classList.remove('flex'));
            addCustomRosterPlayerBtn.addEventListener('click', addPlayerToCustomRosterUI);
            importRosterArchiveInput.addEventListener('change', importCustomRosters);


            switchView('archiv');
        }
        
        function switchView(viewName) {
            // Cancel editing mode if switching away
            if (currentlyEditingGameId && viewName !== 'eingabe') {
                resetToNewEntryMode();
            }

            Object.values(views).forEach(view => view.classList.remove('view-active'));
            Object.values(tabs).forEach(tab => tab.classList.remove('tab-active'));

            if (views[viewName]) {
                views[viewName].classList.add('view-active');
            }
            // Highlight the correct tab
            if (tabs[viewName]) {
                tabs[viewName].classList.add('tab-active');
            } else if (viewName === 'eingabe') {
                tabs.archiv.classList.add('tab-active');
            }
            
            if (viewName === 'einstellungen') {
                renderSettings();
                switchSettingsSubView('kader'); // Default to Kader sub-tab
            }

            // Handle placeholder for the evaluation view
            if (viewName === 'spielauswertung') {
                if (currentlyLoadedGameId) {
                    spielauswertungPlaceholder.style.display = 'none';
                    spielauswertungContent.style.display = 'block';
                } else {
                    spielauswertungPlaceholder.style.display = 'block';
                    spielauswertungContent.style.display = 'none';
                }
            }
        }

        function switchSettingsSubView(subViewName) {
            document.querySelectorAll('.sub-view').forEach(v => v.classList.remove('sub-view-active'));
            document.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('sub-tab-active'));

            const activeView = document.getElementById(`subview-${subViewName}`);
            const activeBtn = document.getElementById(`subtab-${subViewName}`);

            if (activeView) activeView.classList.add('sub-view-active');
            if (activeBtn) activeBtn.classList.add('sub-tab-active');
        }


        function switchDetailView(detailViewName) {
            if (detailViewName === 'graphical') {
                detailTabGraphical.classList.add('border-indigo-500', 'text-indigo-600');
                detailTabGraphical.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                detailTabTabular.classList.remove('border-indigo-500', 'text-indigo-600');
                detailTabTabular.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                
                detailContentGraphical.style.display = 'block';
                detailContentTabular.style.display = 'none';
            } else if (detailViewName === 'tabular') {
                detailTabTabular.classList.add('border-indigo-500', 'text-indigo-600');
                detailTabTabular.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                detailTabGraphical.classList.remove('border-indigo-500', 'text-indigo-600');
                detailTabGraphical.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');

                detailContentGraphical.style.display = 'none';
                detailContentTabular.style.display = 'block';
            }
        }

        function startEditing(gameId) {
            const gameToEdit = allGames.find(g => g.id === gameId);
            if (!gameToEdit) return;

            currentlyEditingGameId = gameId;
            gameDataInput.value = gameToEdit.rawText;
            
            eingabeTitle.textContent = `Spiel bearbeiten (ID: ${gameId})`;
            processBtn.innerHTML = '<span class="sm:hidden">Änderungen speichern</span><span class="hidden sm:inline">Änderungen speichern</span>';
            processBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            processBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            cancelBtn.style.display = 'block';

            switchView('eingabe');
        }

        function resetToNewEntryMode() {
            currentlyEditingGameId = null;
            gameDataInput.value = `Presseinformation - lang
OWLmB-KL1, Spiel Nr. 621114216 am 28.09.24
Heim - Gast SG Bünde-Dünne - HSG Hüllhorst II
Ergebnis 30:25 (15:12)
... (füge hier den Rest des Berichts ein)`;
            inputStatus.innerHTML = '';
            
            eingabeTitle.textContent = 'Neues Spiel hinzufügen';
            processBtn.innerHTML = '<span class="sm:hidden">Analysieren & Speichern</span><span class="hidden sm:inline">Spiel analysieren & hinzufügen</span>';
            processBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            processBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            cancelBtn.style.display = 'block';
        }

        function showConfirmation(message, onConfirm) {
            confirmationMessage.textContent = message;
            confirmationModal.classList.add('flex');

            const confirmHandler = () => {
                confirmationModal.classList.remove('flex');
                onConfirm();
                confirmOkBtn.removeEventListener('click', confirmHandler);
                confirmCancelBtn.removeEventListener('click', cancelHandler);
            };

            const cancelHandler = () => {
                confirmationModal.classList.remove('flex');
                confirmOkBtn.removeEventListener('click', confirmHandler);
                confirmCancelBtn.removeEventListener('click', cancelHandler);
            };

            confirmOkBtn.addEventListener('click', confirmHandler);
            confirmCancelBtn.addEventListener('click', cancelHandler);
        }

        function showNotification(message, type = 'info') {
            notificationElement.textContent = message;
            notificationElement.className = `notification bg-${type}`;
            notificationElement.classList.add('show');
            setTimeout(() => {
                notificationElement.classList.remove('show');
            }, 3000);
        }

        function showConnectionDetailsModal() {
            modalAppId.textContent = appId || 'N/A';
            modalUserId.textContent = userId || 'Anonym';
            modalConnectionStatus.textContent = connectionStatusText.textContent;
            modalDbPath.textContent = gamesCollectionRef ? gamesCollectionRef.path : 'N/A';
            connectionDetailsModal.classList.add('flex');
        }

        // --- DATA PARSING & FORMATTING ---
        function formatRawTextForEditing(rawText) {
            if (!rawText) return '';
            let text = rawText.trim();
            text = text.replace(/\r\n/g, '\n');
            text = text.replace(/([^\n])\n(Mannschaftslisten|Spielverlauf|Gast:)/g, '$1\n\n$2');
            return text;
        }

        function cleanReport(text) {
            const pageMarkerRegex = /Handball4all AG Seite \d\/\d.*?\n/g;
            return text.split(pageMarkerRegex).map((part, index) => {
                if (index === 0) return part;
                return part.replace(/Presseinformation - lang\n.*?\n/, '');
            }).join('');
        }

        function parsePlayerList(rosterSection) {
            const players = [];
            const lines = rosterSection.split('\n');
            for (const line of lines) {
                if (!/^\s*\d+\s/.test(line) || /\d{2}:\d{2}:\d{2}/.test(line) || line.includes("Jahrgang") || line.includes("Disq.")) {
                    continue;
                }
                const parts = line.trim().split(/\s+/).filter(Boolean);
                if (parts.length < 2) continue;
                const number = parseInt(parts[0]);
                if (isNaN(number)) continue;
                let goals = 0, sevenMeterGoals = 0, sevenMetersAttempted = 0, warnings = 0, suspensions = 0;
                let nameEndIndex = parts.length;
                let timeStampCount = 0;
                for (let i = parts.length - 1; i > 0; i--) {
                    if (/\d{1,2}:\d{2}/.test(parts[i])) {
                        timeStampCount++;
                        nameEndIndex = i;
                    } else { break; }
                }
                if (timeStampCount > 0) warnings = 1;
                if (timeStampCount > 1) suspensions = timeStampCount - 1;
                if (nameEndIndex > 1 && /\d+\/\d+/.test(parts[nameEndIndex - 1])) {
                    const sevenMeterStats = parts[nameEndIndex - 1].split('/');
                    // Corrected based on user feedback: The format is Versuche/Tore (Attempts/Goals).
                    sevenMetersAttempted = parseInt(sevenMeterStats[0], 10);
                    sevenMeterGoals = parseInt(sevenMeterStats[1], 10);
                    nameEndIndex--;
                }
                if (nameEndIndex > 1 && /^\d+$/.test(parts[nameEndIndex - 1])) {
                    goals = parseInt(parts[nameEndIndex - 1]);
                    nameEndIndex--;
                }
                const namePart = parts.slice(1, nameEndIndex).join(' ').replace(/N\.N\./g, '').trim();
                let uniqueIdentifier = namePart || `Spieler #${number}`;
                players.push({ number, name: uniqueIdentifier, goals, sevenMeterGoals, sevenMetersAttempted, warnings, suspensions });
            }
            return players;
        }

        function timeToMinutes(timeStr) {
            const [minutes, seconds] = timeStr.split(':').map(Number);
            return minutes + seconds / 60;
        }
        
        function parseEventsFromLog(logSection, homeTeam, guestTeam, homePlayerMap, guestPlayerMap) {
            const goalEvents = [];
            const scoreProgression = [{time: '00:00', timeValue: 0, score: [0, 0]}];
            if (!logSection) return { goalEvents, scoreProgression };
            const lines = logSection.split('\n');
            const goalRegex = /\d{2}:\d{2}:\d{2}\s+(\d{2}:\d{2})\s+(\d+:\d+)\s+((7m-)?Tor) durch (.*)/;
            for (const line of lines) {
                const match = line.match(goalRegex);
                if (match) {
                    const time = match[1];
                    const timeValue = timeToMinutes(time);
                    const currentScore = match[2].split(':').map(Number);
                    const is7m = match[3].startsWith('7m');
                    const scorerInfo = match[5].trim();
                    const lastKnownScore = scoreProgression[scoreProgression.length - 1].score;
                    scoreProgression.push({ time, timeValue, score: currentScore });
                    let teamName = '';
                    const homeScoreIncreased = currentScore[0] > lastKnownScore[0];
                    const guestScoreIncreased = currentScore[1] > lastKnownScore[1];
                    if (homeScoreIncreased && !guestScoreIncreased) { teamName = homeTeam; } 
                    else if (guestScoreIncreased && !homeScoreIncreased) { teamName = guestTeam; } 
                    else { if (homeScoreIncreased) { teamName = homeTeam; } else if (guestScoreIncreased) { teamName = guestTeam; } }
                    if (teamName) {
                        let scorerName = '';
                        const pattern1 = scorerInfo.match(/(.*?)\s+\(\d+/); 
                        const pattern2 = scorerInfo.match(/Spieler (\d+)/); 
                        if (pattern1) { scorerName = pattern1[1].trim(); } 
                        else if (pattern2) { const playerNumber = parseInt(pattern2[1]); const map = teamName === homeTeam ? homePlayerMap : guestPlayerMap; scorerName = map[playerNumber] || `Spieler #${playerNumber}`; } 
                        else { scorerName = scorerInfo.split(',')[0].trim(); }
                        if (scorerName) { const teamScore = teamName === homeTeam ? currentScore[0] : currentScore[1]; goalEvents.push({ time, timeValue, scorer: scorerName, team: teamName, score: teamScore, is7m }); }
                    }
                }
            }
            return { goalEvents, scoreProgression };
        }

        function parseGameReport(text) {
            try {
                const cleanedText = cleanReport(text);
                const game = { rawText: text };
                const idMatch = cleanedText.match(/Spiel Nr\. (\d+)/);
                if (!idMatch) { console.error("Parsing Error: 'Spiel Nr.' not found."); return null; }
                game.id = idMatch[1];
                const dateMatch = cleanedText.match(/am (\d{2}\.\d{2}\.\d{2})/);
                if (!dateMatch) { console.error("Parsing Error: Date with 'am' not found."); return null; }
                game.date = dateMatch[1];
                const teamsMatch = cleanedText.match(/Heim - Gast (.*?) - (.*?)\n/);
                if (!teamsMatch) { console.error("Parsing Error: 'Heim - Gast' line not found."); return null; }
                game.homeTeam = teamsMatch[1].trim();
                game.guestTeam = teamsMatch[2].trim();
                const scoreMatch = cleanedText.match(/(?:Endstand|Ergebnis)\s*(?:\(.*\)\s*)?(\d+:\d+)/);
                if (!scoreMatch) { console.error("Parsing Error: 'Endstand' or 'Ergebnis' with score not found."); return null; }
                game.finalScore = scoreMatch[1];
                const rosterSplit = cleanedText.split('Mannschaftslisten');
                if (rosterSplit.length < 2) { console.error("Parsing Error: 'Mannschaftslisten' section not found."); return null; }
                const rosterSection = rosterSplit[1];
                const guestSplit = rosterSection.split('Gast:');
                if (guestSplit.length < 2) { console.error("Parsing Error: 'Gast:' section for guest roster not found."); return null; }
                const [homeRoster, guestRoster] = guestSplit;
                const homePlayers = parsePlayerList(homeRoster);
                const guestPlayers = parsePlayerList(guestRoster);
                game.players = [ ...homePlayers.map(p => ({...p, team: game.homeTeam})), ...guestPlayers.map(p => ({...p, team: game.guestTeam})) ];
                const homePlayerMap = Object.fromEntries(homePlayers.map(p => [p.number, p.name]));
                const guestPlayerMap = Object.fromEntries(guestPlayers.map(p => [p.number, p.name]));
                const logSection = cleanedText.split('Spielverlauf')[1];
                const { goalEvents, scoreProgression } = parseEventsFromLog(logSection, game.homeTeam, game.guestTeam, homePlayerMap, guestPlayerMap);
                game.goalEvents = goalEvents;
                game.scoreProgression = scoreProgression;
                return game;
            } catch (error) {
                console.error("An unexpected error occurred during parsing:", error);
                return null;
            }
        }

        // --- DATA HANDLING -> Firestore ---
        async function handleProcessAndSaveGame() {
            if (!isAuthReady || !gamesCollectionRef) {
                showNotification("Datenbank ist nicht bereit. Bitte warten.", "error");
                return;
            }
            const text = gameDataInput.value.trim();
            if (!text) {
                showNotification("Bitte Spieldaten einfügen.", "info");
                return;
            }
            inputStatus.innerHTML = `<p class="text-blue-600">Analysiere Daten...</p>`;
            const gameData = parseGameReport(text);
            if (!gameData) {
                inputStatus.innerHTML = `<p class="text-red-500">Fehler beim Auslesen der Daten. Bitte überprüfe das Format.</p>`;
                return;
            }
            gameData.rawText = formatRawTextForEditing(text);
            const isUpdating = allGames.some(g => g.id === gameData.id);
            if (isUpdating) {
                const existingGame = allGames.find(g => g.id === gameData.id);
                gameData.nameCorrections = existingGame.nameCorrections || {};
            }
            try {
                const gameDocRef = doc(gamesCollectionRef, gameData.id);
                await setDoc(gameDocRef, gameData, { merge: true });
                const successMessage = currentlyEditingGameId ? `Spiel ${gameData.id} erfolgreich aktualisiert!` : `Spiel ${gameData.id} erfolgreich hinzugefügt!`;
                showNotification(successMessage, 'success');
                inputStatus.innerHTML = '';
                resetToNewEntryMode();
                renderGameDetail(gameData.id, true); // Switch to the detail view after saving
            } catch (error) {
                console.error("Fehler beim Speichern in Firestore:", error);
                inputStatus.innerHTML = `<p class="text-red-500">Fehler beim Speichern der Daten. Bitte versuche es erneut.</p>`;
            }
        }

        async function deleteGame(gameId) {
            if (!isAuthReady || !gamesCollectionRef) {
                showNotification("Datenbank ist nicht bereit.", "error");
                return;
            }
            try {
                const gameDocRef = doc(gamesCollectionRef, gameId);
                await deleteDoc(gameDocRef);
                if (currentlyLoadedGameId === gameId) {
                    currentlyLoadedGameId = null;
                }
                showNotification(`Spiel ${gameId} erfolgreich gelöscht.`, 'success');
            } catch (error) {
                console.error("Fehler beim Löschen aus Firestore:", error);
                showNotification("Das Spiel konnte nicht gelöscht werden.", 'error');
            }
        }
        
        function updateDynamicContent() {
            renderArchiveList();
            populateTeamSelector();
            renderPlayerCards();
            populatePlayerTeamFilter();
            populateH2hSelectors();
            renderStatistics();
            if (selectedPlayerName) renderPlayerProfile(selectedPlayerName, false);
            
            if (currentlyLoadedGameId) {
                const gameExists = allGames.some(g => g.id === currentlyLoadedGameId);
                if (gameExists) { 
                    renderGameDetail(currentlyLoadedGameId, false); 
                } else { 
                    currentlyLoadedGameId = null;
                    switchView('spielauswertung');
                }
            } else {
                 const activeTabEl = document.querySelector('.tab-active');
                 if (activeTabEl) {
                     switchView(activeTabEl.id.replace('tab-',''));
                 }
            }
        }

        // --- NAME CORRECTION ---
        function getCorrectedName(game, originalName) {
            return game.nameCorrections?.[originalName] || originalName;
        }

        function openNameCorrectionModal() {
            const game = allGames.find(g => g.id === currentlyLoadedGameId);
            if (!game) return;
            nameCorrectionList.innerHTML = '';
            
            const createTeamList = (teamName, playersOfTeam) => {
                const uniquePlayers = Array.from(new Map(playersOfTeam.map(p => [p.name, p])).values());
                if (uniquePlayers.length > 0) {
                    const teamHeader = document.createElement('h4');
                    teamHeader.className = 'text-md font-bold text-gray-800 mt-4 first:mt-0';
                    teamHeader.textContent = getCorrectedName(game, teamName);
                    nameCorrectionList.appendChild(teamHeader);
                    
                    uniquePlayers.forEach(player => {
                        const originalName = player.name;
                        const correctedName = getCorrectedName(game, originalName);
                        const div = document.createElement('div');
                        div.className = 'player-correction-item space-y-1 py-2 border-t first:border-t-0';
                        
                        const customRosterOptions = allCustomRosters.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
                        const rosterSelectHtml = `
                            <select class="custom-roster-select w-full p-1 mt-1 border border-gray-200 rounded-md bg-gray-50 text-sm" data-player-select-id="player-select-${originalName.replace(/\s+/g, '-')}">
                                <option value="">-- Aus Kader Archiv wählen --</option>
                                ${customRosterOptions}
                            </select>
                            <select id="player-select-${originalName.replace(/\s+/g, '-')}" class="roster-select w-full p-1 mt-1 border border-gray-200 rounded-md bg-gray-50 text-sm" data-input-for-original-name="${originalName}" disabled>
                                <option value="">-- Spieler wählen --</option>
                            </select>
                        `;
                        
                        div.innerHTML = `
                            <div>
                                <label class="text-gray-600 font-medium truncate" title="${originalName}">${originalName}</label>
                            </div>
                            <input type="text" value="${correctedName}" data-original-name="${originalName}" class="p-2 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                             ${rosterSelectHtml}
                        `;
                        nameCorrectionList.appendChild(div);

                        // Auto-select roster if team name matches a roster name
                        const rosterSelect = div.querySelector('.custom-roster-select');
                        const matchingRoster = allCustomRosters.find(r => r.name === getCorrectedName(game, teamName));
                        if (rosterSelect && matchingRoster) {
                            rosterSelect.value = matchingRoster.id;
                            handleCustomRosterSelectionChange(rosterSelect);
                        }
                    });
                }
            };
            
            const homePlayers = game.players.filter(p => p.team === game.homeTeam);
            createTeamList(game.homeTeam, homePlayers);
            const guestPlayers = game.players.filter(p => p.team === game.guestTeam);
            createTeamList(game.guestTeam, guestPlayers);

            nameCorrectionModal.classList.add('flex');
        }
        
        function handleCustomRosterSelectionChange(selectElement) {
            const rosterId = selectElement.value;
            const playerSelectId = selectElement.dataset.playerSelectId;
            const playerSelect = document.getElementById(playerSelectId);

            if (!playerSelect) return;

            playerSelect.innerHTML = '<option value="">-- Spieler wählen --</option>';
            playerSelect.disabled = true;

            if (rosterId) {
                const selectedRoster = allCustomRosters.find(r => r.id === rosterId);
                if (selectedRoster && selectedRoster.roster) {
                    const playerOptions = Object.values(selectedRoster.roster)
                        .map(name => `<option value="${name}">${name}</option>`)
                        .join('');
                    playerSelect.innerHTML += playerOptions;
                    playerSelect.disabled = false;
                }
            }
        }

        function handlePlayerSelectionChange(selectElement) {
            const originalName = selectElement.dataset.inputForOriginalName;
            const selectedValue = selectElement.value;
            const inputField = nameCorrectionList.querySelector(`input[data-original-name="${originalName}"]`);
            if (inputField && selectedValue) {
                inputField.value = selectedValue;
            }
        }


        async function saveNameCorrections() {
            if (!isAuthReady || !gamesCollectionRef) {
                showNotification("Datenbank ist nicht bereit.", "error");
                return;
            }
            const game = allGames.find(g => g.id === currentlyLoadedGameId);
            if (!game) return;

            const newCorrections = { ...(game.nameCorrections || {}) };
            const inputs = nameCorrectionList.querySelectorAll('input[data-original-name]');
            
            inputs.forEach(input => {
                const originalName = input.dataset.originalName;
                const newName = input.value.trim();
                
                if (newName && newName !== originalName) {
                    newCorrections[originalName] = newName;
                } else if (!newName || newName === originalName) {
                    // Remove correction if it's empty or same as original
                    delete newCorrections[originalName];
                }
            });

            try {
                const gameDocRef = doc(gamesCollectionRef, game.id);
                await updateDoc(gameDocRef, { nameCorrections: newCorrections });
                nameCorrectionModal.classList.remove('flex');
                showNotification("Namen erfolgreich gespeichert.", 'success');
            } catch (error) {
                console.error("Fehler beim Speichern der Namenskorrekturen:", error);
                showNotification("Die Korrekturen konnten nicht gespeichert werden.", 'error');
            }
        }

        // --- IMPORT / EXPORT ---
        function exportAllData() {
            if (allGames.length === 0 && allCustomRosters.length === 0) {
                showNotification("Keine Daten zum Exportieren vorhanden.", "info");
                return;
            }
            const dataToExport = {
                games: allGames,
                customRosters: allCustomRosters.map(({ id, ...rest }) => rest), // Export without Firestore IDs
            };
            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `handball_statistik_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification("Komplettes Backup wird exportiert...", "success");
        }

        async function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!importedData || !Array.isArray(importedData.games) || !Array.isArray(importedData.customRosters)) {
                        throw new Error("Die importierte Datei hat ein ungültiges Format oder es fehlen 'games'/'customRosters'.");
                    }
                    
                    showConfirmation("Möchten Sie wirklich alle Daten überschreiben? Diese Aktion kann nicht rückgängig gemacht werden.", async () => {
                        if (!isAuthReady) {
                            showNotification("Datenbank ist nicht bereit.", "error");
                            return;
                        }
                        dataImportStatus.innerHTML = `<p class="text-blue-600">Lösche alte Daten und importiere Backup...</p>`;
                        
                        try {
                            const batch = writeBatch(db);
                            
                            // Delete all existing documents
                            const gamesSnapshot = await getDocs(gamesCollectionRef);
                            gamesSnapshot.forEach(doc => batch.delete(doc.ref));
                            
                            const rostersSnapshot = await getDocs(customRostersCollectionRef);
                            rostersSnapshot.forEach(doc => batch.delete(doc.ref));

                            // Add imported documents
                            importedData.games.forEach(game => {
                                const gameDocRef = doc(gamesCollectionRef, game.id.toString());
                                batch.set(gameDocRef, game);
                            });
                            
                            importedData.customRosters.forEach(roster => {
                                const rosterDocRef = doc(customRostersCollectionRef);
                                batch.set(rosterDocRef, roster);
                            });

                            await batch.commit();

                            dataImportStatus.innerHTML = `<p class="text-green-600">Import erfolgreich! Alle Daten wurden wiederhergestellt.</p>`;
                            showNotification("Alle Daten erfolgreich importiert.", "success");

                        } catch (error) {
                            console.error("Full Import Error:", error);
                            dataImportStatus.innerHTML = `<p class="text-red-500">Fehler beim Import: ${error.message}</p>`;
                        } finally {
                            importAllFileInput.value = '';
                            setTimeout(() => { dataImportStatus.innerHTML = '' }, 5000);
                        }
                    });
                } catch (error) {
                     console.error("File Read/Parse Error:", error);
                     showNotification(`Fehler beim Lesen der Datei: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
        }

        // --- RENDERING FUNCTIONS ---
        function renderArchiveList() {
            if (!isAuthReady) {
                gameArchiveList.innerHTML = `<p class="text-gray-500">Verbinde mit der Datenbank...</p>`;
                return;
            }

            const primaryTeam = archiveSearchInput.value.toLowerCase().trim();
            const locationFilter = archiveFilterLocation.value;
            const opponentFilter = archiveFilterOpponent.value;

            let gamesToShow = [...allGames];

            if (primaryTeam) {
                populateArchiveOpponentFilter(primaryTeam);
                gamesToShow = gamesToShow.filter(game => {
                    const homeTeam = getCorrectedName(game, game.homeTeam).toLowerCase();
                    const guestTeam = getCorrectedName(game, game.guestTeam).toLowerCase();
                    return homeTeam.includes(primaryTeam) || guestTeam.includes(primaryTeam);
                });
                
                if (locationFilter !== 'all') {
                    gamesToShow = gamesToShow.filter(game => {
                        const homeTeam = getCorrectedName(game, game.homeTeam).toLowerCase();
                        if (locationFilter === 'home') {
                            return homeTeam.includes(primaryTeam);
                        }
                        if (locationFilter === 'away') {
                            return !homeTeam.includes(primaryTeam);
                        }
                        return true;
                    });
                }
                
                if (opponentFilter !== 'all') {
                    gamesToShow = gamesToShow.filter(game => {
                        const homeTeam = getCorrectedName(game, game.homeTeam);
                        const guestTeam = getCorrectedName(game, game.guestTeam);
                        return homeTeam === opponentFilter || guestTeam === opponentFilter;
                    });
                }
            } else {
                 populateArchiveOpponentFilter(null);
            }
            
            if (gamesToShow.length === 0) {
                gameArchiveList.innerHTML = `<p class="text-gray-500">Keine Spiele für die gewählten Filter gefunden.</p>`;
                return;
            }

            gameArchiveList.innerHTML = gamesToShow.map(game => {
                const homeTeam = getCorrectedName(game, game.homeTeam);
                const guestTeam = getCorrectedName(game, game.guestTeam);
                return `
                <div data-game-id="${game.id}" class="game-entry-btn border border-gray-200 p-3 rounded-lg hover:bg-gray-50 hover:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition cursor-pointer">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-2">
                        <div class="flex-grow">
                            <p class="font-bold text-base sm:text-lg">${homeTeam} vs ${guestTeam}</p>
                            <p class="text-xs sm:text-sm text-gray-500">Datum: ${game.date} | ID: ${game.id}</p>
                        </div>
                        <div class="flex items-center justify-between w-full sm:w-auto">
                             <p class="text-xl sm:text-2xl font-bold text-indigo-600">${game.finalScore}</p>
                             <div class="flex items-center space-x-2 ml-4">
                                 <div data-game-id="${game.id}" class="edit-game-btn text-gray-400 hover:text-yellow-500 p-2 rounded-full hover:bg-yellow-100" title="Spiel bearbeiten">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                 </div>
                                 <div data-game-id="${game.id}" class="delete-game-btn text-gray-400 hover:text-red-500 p-2 rounded-full hover:bg-red-100" title="Spiel löschen">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                 </div>
                             </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }
        
        function populateArchiveOpponentFilter(primaryTeam) {
            const opponents = new Set();
            if (primaryTeam) {
                archiveFilterOpponent.disabled = false;
                const gamesOfPrimaryTeam = allGames.filter(game => {
                    const home = getCorrectedName(game, game.homeTeam).toLowerCase();
                    const guest = getCorrectedName(game, game.guestTeam).toLowerCase();
                    return home.includes(primaryTeam) || guest.includes(primaryTeam);
                });
                
                gamesOfPrimaryTeam.forEach(game => {
                    const home = getCorrectedName(game, game.homeTeam);
                    const guest = getCorrectedName(game, game.guestTeam);
                    if (home.toLowerCase().includes(primaryTeam)) {
                        opponents.add(guest);
                    } else {
                        opponents.add(home);
                    }
                });
            } else {
                archiveFilterOpponent.disabled = true;
            }

            const sortedOpponents = [...opponents].sort((a,b) => a.localeCompare(b));
            const currentSelection = archiveFilterOpponent.value;
            archiveFilterOpponent.innerHTML = '<option value="all">Alle Gegner</option>';
            sortedOpponents.forEach(op => {
                archiveFilterOpponent.innerHTML += `<option value="${op}">${op}</option>`;
            });
            if (sortedOpponents.includes(currentSelection)) {
                archiveFilterOpponent.value = currentSelection;
            }
        }
        
        const playerColors = {};
        const colorPalette = [ '#d62828', '#f77f00', '#0081a7', '#00afb9', '#8338ec', '#3a86ff', '#ff006e', '#e63946', '#2a9d8f', '#f4a261', '#e76f51', '#6a994e', '#a7c957', '#3d405b', '#d90429', '#023047', '#fb8500', '#219ebc', '#ffb703', '#7cb518' ];
        let colorIndex = 0;

        function getPlayerColor(playerName) {
            if (!playerColors[playerName]) {
                playerColors[playerName] = colorPalette[colorIndex % colorPalette.length];
                colorIndex++;
            }
            return playerColors[playerName];
        }

        function updateChartWithSelectedPlayers(game) {
            if (!scoreChart) return;
            scoreChart.data.datasets = scoreChart.data.datasets.filter(ds => ds.type !== 'scatter');
            selectedPlayers.forEach(playerName => {
                const playerEvents = (game.goalEvents || []).filter(event => getCorrectedName(game, event.scorer) === playerName);
                const dataPoints = playerEvents.map(event => ({ x: event.timeValue, y: event.score, is7m: event.is7m }));
                scoreChart.data.datasets.push({
                    type: 'scatter', label: playerName, data: dataPoints,
                    backgroundColor: getPlayerColor(playerName),
                    radius: dataPoints.map(e => e.is7m ? 10 : 8),
                    pointStyle: dataPoints.map(e => e.is7m ? 'triangle' : 'circle'),
                    hoverRadius: 12,
                });
            });
            scoreChart.update();
        }

        function calculateStreaks(game) {
            const streaks = [{ timeValue: 0, homeStreak: 0, guestStreak: 0 }];
            if (!game.scoreProgression || game.scoreProgression.length < 2) { return streaks; }
            let homeRun = 0; let guestRun = 0; let lastScore = [0, 0];
            for (let i = 1; i < game.scoreProgression.length; i++) {
                const entry = game.scoreProgression[i];
                const currentScore = entry.score;
                if (currentScore[0] > lastScore[0]) { homeRun++; guestRun = 0; } 
                else if (currentScore[1] > lastScore[1]) { guestRun++; homeRun = 0; }
                streaks.push({ timeValue: entry.timeValue, homeStreak: homeRun, guestStreak: -guestRun });
                lastScore = currentScore;
            }
            return streaks;
        }

        function renderScoringRunChart(game) {
            if (scoringRunChart) { scoringRunChart.destroy(); }
            const streakData = calculateStreaks(game);
            scoringRunChart = new Chart(scoringRunChartCanvas, {
                type: 'line', data: {
                    labels: streakData.map(s => s.timeValue),
                    datasets: [ {
                        label: getCorrectedName(game, game.homeTeam), data: streakData.map(s => s.homeStreak),
                        backgroundColor: 'rgba(79, 70, 229, 0.5)', borderColor: 'rgba(79, 70, 229, 1)',
                        stepped: true, fill: true, pointRadius: 0,
                    }, {
                        label: getCorrectedName(game, game.guestTeam), data: streakData.map(s => s.guestStreak),
                        backgroundColor: 'rgba(220, 38, 38, 0.5)', borderColor: 'rgba(220, 38, 38, 1)',
                        stepped: true, fill: true, pointRadius: 0,
                    } ] },
                options: { responsive: true, maintainAspectRatio: false, plugins: {
                    title: { display: true, text: 'Tor-Rhythmus (Läufe)' },
                    tooltip: { callbacks: {
                        title: function(context) {
                            const dp = context[0]; const min = Math.floor(dp.label); const sec = Math.round((dp.label - min) * 60);
                            return `Minute: ${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
                        },
                        label: function(context) {
                            const val = context.raw;
                            if (val > 0) return `${context.dataset.label}: ${val}:0 Lauf`;
                            if (val < 0) return `${context.dataset.label}: ${-val}:0 Lauf`;
                            return null;
                        } } } },
                scales: {
                    x: { type: 'linear', title: { display: true, text: 'Spielzeit (Minuten)' }, ticks: { stepSize: 5 } },
                    y: { title: { display: true, text: 'Anzahl Tore in Folge' }, ticks: { callback: v => Math.abs(v) } } } }
            });
        }

        function renderGameDetail(gameId, doSwitchView = false) {
            const game = allGames.find(g => g.id === gameId);
            if (!game) {
                currentlyLoadedGameId = null;
                switchView('spielauswertung'); // Show placeholder
                return;
            }
            currentlyLoadedGameId = gameId; 
            selectedPlayers = []; 
            
            spielauswertungPlaceholder.style.display = 'none';
            spielauswertungContent.style.display = 'block';

            gameDetailTitle.textContent = `${getCorrectedName(game, game.homeTeam)} vs ${getCorrectedName(game, game.guestTeam)}`;
            gameDetailSubtitle.textContent = `Endstand: ${game.finalScore} am ${game.date}`;

            populateGameNavigation(gameId);

            if (scoreChart) { scoreChart.destroy(); }
            const datasets = [ {
                    label: getCorrectedName(game, game.homeTeam), data: game.scoreProgression.map(p => ({x: p.timeValue, y: p.score[0]})),
                    borderColor: 'rgba(79, 70, 229, 0.8)', backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    tension: 0.1, fill: true, pointRadius: 0,
                }, {
                    label: getCorrectedName(game, game.guestTeam), data: game.scoreProgression.map(p => ({x: p.timeValue, y: p.score[1]})),
                    borderColor: 'rgba(220, 38, 38, 0.8)', backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    tension: 0.1, fill: true, pointRadius: 0,
                } ];
            scoreChart = new Chart(scoreChartCanvas, {
                type: 'line', data: { datasets },
                options: { responsive: true, maintainAspectRatio: false, plugins: {
                    legend: { position: 'top', labels: { filter: item => item.datasetIndex < 2 } },
                    title: { display: true, text: 'Spielverlauf' },
                    tooltip: { callbacks: {
                        title: function(context) {
                            const dp = context[0].raw; const min = Math.floor(dp.x); const sec = Math.round((dp.label - min) * 60);
                            return `Minute: ${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
                        },
                        label: function(context) {
                            if (context.dataset.type === 'scatter') { const goalType = context.raw.is7m ? " (7m)" : ""; return `${context.dataset.label}: Tor zum ${context.raw.y}${goalType}`; }
                            return `${context.dataset.label}: ${context.formattedValue}`;
                        } } } },
                scales: {
                    x: { type: 'linear', title: { display: true, text: 'Spielzeit (Minuten)' }, ticks: { stepSize: 5 } },
                    y: { beginAtZero: true, title: { display: true, text: 'Tore' }, ticks: { stepSize: 1 } } } }
            });
            const goalCounts = {};
            (game.goalEvents || []).forEach(event => {
                const correctedScorer = getCorrectedName(game, event.scorer);
                if (!goalCounts[correctedScorer]) { goalCounts[correctedScorer] = { name: correctedScorer, team: event.team, count: 0 }; }
                goalCounts[correctedScorer].count++;
            });
            const homeScorers = Object.values(goalCounts).filter(p => p.team === game.homeTeam).sort((a,b) => b.count - a.count);
            const guestScorers = Object.values(goalCounts).filter(p => p.team === game.guestTeam).sort((a,b) => b.count - a.count);
            let playerListHtml = '';
            if (homeScorers.length > 0) {
                playerListHtml += `<h4 class="font-semibold text-sm text-gray-800 mb-1">${getCorrectedName(game, game.homeTeam)}</h4>`;
                playerListHtml += homeScorers.map(scorer => `<button class="player-goal-btn w-full text-left p-2 rounded-md hover:bg-gray-200 transition" data-player-name="${scorer.name}"><span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: ${getPlayerColor(scorer.name)}"></span>${scorer.name} <span class="text-gray-500 font-medium">(${scorer.count})</span></button>`).join('');
            }
            if (guestScorers.length > 0) {
                playerListHtml += `<h4 class="font-semibold text-sm text-gray-800 mt-3 mb-1">${getCorrectedName(game, game.guestTeam)}</h4>`;
                playerListHtml += guestScorers.map(scorer => `<button class="player-goal-btn w-full text-left p-2 rounded-md hover:bg-gray-200 transition" data-player-name="${scorer.name}"><span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: ${getPlayerColor(scorer.name)}"></span>${scorer.name} <span class="text-gray-500 font-medium">(${scorer.count})</span></button>`).join('');
            }
            playerGoalList.innerHTML = playerListHtml || '<p class="text-sm text-gray-500">Keine Tordaten im Spielverlauf gefunden.</p>';
            renderScoringRunChart(game);
            
            renderTabularDetailContent(game);

            if (doSwitchView) {
                switchView('spielauswertung');
            }
            switchDetailView('tabular');
        }

        function renderTabularDetailContent(game) {
            let contentHtml = '';
            const renderPlayerTable = (teamName, players) => {
                let tableHtml = `<div class="overflow-x-auto"><h3 class="text-xl font-bold mb-2 text-indigo-700">${getCorrectedName(game, teamName)}</h3><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Spieler</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tore</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">7m</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Verwarnungen">V</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="2-Minuten-Strafen">2'</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                players.forEach(p => {
                    tableHtml += `<tr><td class="px-4 py-4 whitespace-nowrap font-medium clickable-player" data-player-name="${getCorrectedName(game, p.name)}">${getCorrectedName(game, p.name)}</td><td class="px-4 py-4 whitespace-nowrap">${p.goals}</td><td class="px-4 py-4 whitespace-nowrap">${p.sevenMeterGoals}/${p.sevenMetersAttempted}</td><td class="px-4 py-4 whitespace-nowrap">${p.warnings}</td><td class="px-4 py-4 whitespace-nowrap">${p.suspensions}</td></tr>`;
                });
                tableHtml += `</tbody></table></div>`;
                return tableHtml;
            };
            contentHtml += `<h2 class="text-2xl font-bold mb-4">Spielerstatistiken</h2>`;
            const homePlayers = game.players.filter(p => p.team === game.homeTeam);
            const guestPlayers = game.players.filter(p => p.team === game.guestTeam);
            contentHtml += '<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">';
            contentHtml += renderPlayerTable(game.homeTeam, homePlayers);
            contentHtml += renderPlayerTable(game.guestTeam, guestPlayers);
            contentHtml += '</div>';
            contentHtml += `<h2 class="text-2xl font-bold mt-8 mb-4">Spielverlauf</h2>`;
            contentHtml += `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Zeit</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Spielstand</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Torschütze</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
            let goalEventIndex = 0;
            game.scoreProgression.forEach((entry, index) => {
                if (index === 0) return; 
                let scorerName = '';
                if (game.goalEvents && goalEventIndex < game.goalEvents.length && Math.abs(game.goalEvents[goalEventIndex].timeValue - entry.timeValue) < 0.02) {
                    scorerName = getCorrectedName(game, game.goalEvents[goalEventIndex].scorer);
                    goalEventIndex++;
                }
                contentHtml += `<tr><td class="px-4 py-4 whitespace-nowrap">${entry.time}</td><td class="px-4 py-4 whitespace-nowrap font-bold">${entry.score.join(' : ')}</td><td class="px-4 py-4 whitespace-nowrap">${scorerName}</td></tr>`;
            });
            contentHtml += `</tbody></table></div>`;
            tabularContentContainer.innerHTML = contentHtml;
        }

        function populateTeamSelector() {
            const teams = new Set();
            allGames.forEach(game => { 
                teams.add(getCorrectedName(game, game.homeTeam)); 
                teams.add(getCorrectedName(game, game.guestTeam)); 
            });
            const sortedTeams = [...teams].sort((a, b) => a.localeCompare(b));
            const currentSelection = teamSelect.value;
            
            teamSelect.innerHTML = '<option value="">-- Team auswählen --</option>';
            sortedTeams.forEach(team => { teamSelect.innerHTML += `<option value="${team}">${team}</option>`; });
            
            if (currentSelection && sortedTeams.includes(currentSelection)) {
                teamSelect.value = currentSelection;
            } else if (sortedTeams.includes("SG Bünde-Dünne")) {
                teamSelect.value = "SG Bünde-Dünne";
            }
        }

        function renderStatistics() {
            const selectedTeam = teamSelect.value;
            if (!selectedTeam) {
                statsContainer.innerHTML = '';
                statsPlaceholder.style.display = 'block';
                return;
            }
            statsPlaceholder.style.display = 'none';
            const teamGames = allGames.filter(g => getCorrectedName(g, g.homeTeam) === selectedTeam || getCorrectedName(g, g.guestTeam) === selectedTeam);
            if (teamGames.length === 0) {
                statsContainer.innerHTML = `<p class="text-gray-500">Für dieses Team wurden keine Spiele gefunden.</p>`;
                return;
            }
            let wins = 0, losses = 0, draws = 0, goalsScored = 0, goalsConceded = 0;
            teamGames.forEach(game => {
                const [homeG, awayG] = game.finalScore.split(':').map(Number);
                if (getCorrectedName(game, game.homeTeam) === selectedTeam) {
                    goalsScored += homeG; goalsConceded += awayG;
                    if (homeG > awayG) wins++; else if (homeG < awayG) losses++; else draws++;
                } else {
                    goalsScored += awayG; goalsConceded += homeG;
                    if (awayG > homeG) wins++; else if (awayG < homeG) losses++; else draws++;
                }
            });

            const totalGames = teamGames.length;
            const winPercentage = totalGames > 0 ? (wins / totalGames) * 100 : 0;
            const drawPercentage = totalGames > 0 ? (draws / totalGames) * 100 : 0;
            const lossPercentage = totalGames > 0 ? (losses / totalGames) * 100 : 0;

            const playerAggregatedStats = {};
            let total7mGoals = 0;
            let total7mAttempts = 0;
            teamGames.forEach(game => {
                (game.players || []).forEach(p => {
                    const correctedTeamName = getCorrectedName(game, p.team);
                    if (correctedTeamName === selectedTeam) {
                        const correctedPlayerName = getCorrectedName(game, p.name);
                        if (!playerAggregatedStats[correctedPlayerName]) {
                            playerAggregatedStats[correctedPlayerName] = { name: correctedPlayerName, games: 0, goals: 0, sevenMeterGoals: 0, sevenMetersAttempted: 0, warnings: 0, suspensions: 0 };
                        }
                        const playerInGame = playerAggregatedStats[correctedPlayerName];
                        playerInGame.games++;
                        playerInGame.goals += p.goals;
                        playerInGame.sevenMeterGoals += p.sevenMeterGoals;
                        playerInGame.sevenMetersAttempted += p.sevenMetersAttempted;
                        playerInGame.warnings += p.warnings;
                        playerInGame.suspensions += p.suspensions;
                        total7mGoals += p.sevenMeterGoals;
                        total7mAttempts += p.sevenMetersAttempted;
                    }
                });
            });

            const sevenMeterQuote = total7mAttempts > 0 ? ((total7mGoals / total7mAttempts) * 100).toFixed(1) : 0;

            const sortedPlayers = Object.values(playerAggregatedStats).sort((a,b) => b.goals - a.goals);
            statsContainer.innerHTML = `
                <div class="bg-gray-50 p-4 sm:p-6 rounded-lg border">
                    <h3 class="text-xl font-bold mb-4 text-indigo-700">Team-Übersicht: ${selectedTeam}</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="bg-white p-3 sm:p-4 rounded-lg shadow"><p class="text-2xl sm:text-3xl font-bold">${totalGames}</p><p class="text-xs sm:text-sm text-gray-500">Spiele</p></div>
                        <div class="bg-white p-3 sm:p-4 rounded-lg shadow"><p class="text-2xl sm:text-3xl font-bold text-green-600">${wins}</p><p class="text-xs sm:text-sm text-gray-500">Siege</p></div>
                        <div class="bg-white p-3 sm:p-4 rounded-lg shadow"><p class="text-2xl sm:text-3xl font-bold text-red-600">${losses}</p><p class="text-xs sm:text-sm text-gray-500">Niederlagen</p></div>
                        <div class="bg-white p-3 sm:p-4 rounded-lg shadow"><p class="text-2xl sm:text-3xl font-bold text-yellow-600">${draws}</p><p class="text-xs sm:text-sm text-gray-500">Unentschieden</p></div>
                        <div class="bg-white p-3 sm:p-4 rounded-lg shadow col-span-2"><p class="text-2xl sm:text-3xl font-bold">${goalsScored} : ${goalsConceded}</p><p class="text-xs sm:text-sm text-gray-500">Torverhältnis</p></div>
                        <div class="bg-white p-3 sm:p-4 rounded-lg shadow col-span-2"><p class="text-2xl sm:text-3xl font-bold">${totalGames > 0 ? (goalsScored / totalGames).toFixed(2) : '0.00'}</p><p class="text-xs sm:text-sm text-gray-500">Tore pro Spiel</p></div>
                    </div>
                    <div class="mt-6">
                        <h4 class="font-semibold mb-2 text-sm">Sieg-Verhältnis</h4>
                        <div class="w-full bg-gray-200 rounded-full h-6 flex overflow-hidden">
                            <div class="bg-green-500 h-full text-white text-xs flex items-center justify-center" style="width: ${winPercentage}%" title="Siege: ${wins}">${Math.round(winPercentage)}%</div>
                            <div class="bg-yellow-500 h-full text-white text-xs flex items-center justify-center" style="width: ${drawPercentage}%" title="Unentschieden: ${draws}">${Math.round(drawPercentage)}%</div>
                            <div class="bg-red-500 h-full text-white text-xs flex items-center justify-center" style="width: ${lossPercentage}%" title="Niederlagen: ${losses}">${Math.round(lossPercentage)}%</div>
                        </div>
                    </div>
                     <div class="mt-6">
                        <h4 class="font-semibold mb-2 text-sm">7-Meter Quote (${total7mGoals} Tore / ${total7mAttempts} Versuche)</h4>
                        <div class="w-full bg-gray-200 rounded-full h-6">
                            <div class="bg-blue-500 h-full rounded-full text-white text-xs flex items-center justify-center" style="width: ${sevenMeterQuote}%">${sevenMeterQuote}%</div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 p-4 sm:p-6 rounded-lg border">
                    <h3 class="text-xl font-bold mb-4 text-indigo-700">Spieler-Statistiken</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Spieler</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sp.</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tore</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">T/S</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">7m</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Verwarnungen">V</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="2-Minuten-Strafen">2'</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${sortedPlayers.map(p => `
                                    <tr>
                                        <td class="px-4 py-4 whitespace-nowrap font-medium clickable-player" data-player-name="${p.name}">${p.name}</td>
                                        <td class="px-4 py-4 whitespace-nowrap">${p.games}</td>
                                        <td class="px-4 py-4 whitespace-nowrap font-bold">${p.goals}</td>
                                        <td class="px-4 py-4 whitespace-nowrap">${p.games > 0 ? (p.goals / p.games).toFixed(2) : '0.00'}</td>
                                        <td class="px-4 py-4 whitespace-nowrap">${p.sevenMeterGoals}/${p.sevenMetersAttempted}</td>
                                        <td class="px-4 py-4 whitespace-nowrap">${p.warnings}</td>
                                        <td class="px-4 py-4 whitespace-nowrap">${p.suspensions}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
        }
        
        function renderPlayerCards() {
            const playerMap = new Map();
            allGames.forEach(game => {
                game.players.forEach(player => {
                    const correctedName = getCorrectedName(game, player.name);
                    if (!playerMap.has(correctedName)) {
                        playerMap.set(correctedName, getCorrectedName(game, player.team));
                    }
                });
            });

            const sortedPlayers = [...playerMap.keys()].sort((a, b) => a.localeCompare(b));
            
            playerCardContainer.innerHTML = '';
            sortedPlayers.forEach(name => {
                const teamName = playerMap.get(name) || 'Unbekannt';
                const card = document.createElement('div');
                card.className = 'player-card bg-white p-3 rounded-lg shadow-sm text-center';
                card.dataset.playerName = name;
                card.dataset.teamName = teamName;
                card.innerHTML = `
                    <p class="font-bold text-sm truncate pointer-events-none" title="${name}">${name}</p>
                    <p class="text-xs text-gray-500 truncate pointer-events-none" title="${teamName}">${teamName}</p>
                `;
                playerCardContainer.appendChild(card);
            });
            filterPlayers();
        }

        function populatePlayerTeamFilter() {
            const teams = new Set();
            allGames.forEach(game => { 
                teams.add(getCorrectedName(game, game.homeTeam)); 
                teams.add(getCorrectedName(game, game.guestTeam)); 
            });
            const sortedTeams = [...teams].sort((a, b) => a.localeCompare(b));
            const currentSelection = playerTeamFilter.value;
            playerTeamFilter.innerHTML = '<option value="all">-- Alle Teams --</option>';
            sortedTeams.forEach(team => { playerTeamFilter.innerHTML += `<option value="${team}">${team}</option>`; });
            
            if (currentSelection && sortedTeams.includes(currentSelection)) {
                playerTeamFilter.value = currentSelection;
            } else if (sortedTeams.includes("SG Bünde-Dünne")) {
                playerTeamFilter.value = "SG Bünde-Dünne";
            }
        }

        function filterPlayers() {
            const lowerCaseSearchTerm = playerSearchInput.value.toLowerCase();
            const selectedTeam = playerTeamFilter.value;

            const cards = playerCardContainer.querySelectorAll('.player-card');
            cards.forEach(card => {
                const playerName = card.dataset.playerName.toLowerCase();
                const teamName = card.dataset.teamName;

                const nameMatch = playerName.includes(lowerCaseSearchTerm);
                const teamMatch = (selectedTeam === 'all' || teamName === selectedTeam);

                if (nameMatch && teamMatch) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }


        function renderPlayerProfile(playerName, doSwitchView = false) {
            selectedPlayerName = playerName;

            if (!playerName) {
                playerProfileContainer.innerHTML = '';
                playerProfilePlaceholder.style.display = 'block';
                return;
            }
            
            if (doSwitchView) {
                switchView('spieler');
            }
            
            document.querySelectorAll('.player-card').forEach(c => c.classList.remove('selected'));
            const selectedCard = document.querySelector(`.player-card[data-player-name="${playerName}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }


            playerProfilePlaceholder.style.display = 'none';

            const stats = { games: 0, goals: 0, sevenMeterGoals: 0, sevenMetersAttempted: 0, warnings: 0, suspensions: 0 };
            const gamesWithPlayer = [];

            allGames.forEach(game => {
                let playerInGame = null;
                game.players.forEach(p => {
                    if (getCorrectedName(game, p.name) === playerName) {
                        playerInGame = p;
                    }
                });

                if (playerInGame) {
                    stats.games++;
                    stats.goals += playerInGame.goals;
                    stats.sevenMeterGoals += playerInGame.sevenMeterGoals;
                    stats.sevenMetersAttempted += playerInGame.sevenMetersAttempted;
                    stats.warnings += playerInGame.warnings;
                    stats.suspensions += playerInGame.suspensions;
                    gamesWithPlayer.push({
                        date: game.date,
                        opponent: getCorrectedName(game, playerInGame.team) === getCorrectedName(game, game.homeTeam) ? getCorrectedName(game, game.guestTeam) : getCorrectedName(game, game.homeTeam),
                        goals: playerInGame.goals
                    });
                }
            });

            const goalsPerGame = stats.games > 0 ? (stats.goals / stats.games).toFixed(2) : '0.00';
            const sevenMeterQuote = stats.sevenMetersAttempted > 0 ? ((stats.sevenMeterGoals / stats.sevenMetersAttempted) * 100).toFixed(1) : '0';

            let html = `
                <div class="bg-gray-50 p-4 sm:p-6 rounded-lg border">
                    <h3 class="text-xl font-bold mb-4 text-indigo-700">${playerName}</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4 text-center">
                        <div class="bg-white p-3 rounded-lg shadow"><p class="text-2xl font-bold">${stats.games}</p><p class="text-xs text-gray-500">Spiele</p></div>
                        <div class="bg-white p-3 rounded-lg shadow"><p class="text-2xl font-bold">${stats.goals}</p><p class="text-xs text-gray-500">Tore</p></div>
                        <div class="bg-white p-3 rounded-lg shadow"><p class="text-2xl font-bold">${goalsPerGame}</p><p class="text-xs text-gray-500">Tore/Spiel</p></div>
                        <div class="bg-white p-3 rounded-lg shadow"><p class="text-2xl font-bold">${sevenMeterQuote}%</p><p class="text-sm text-gray-500">7m (${stats.sevenMeterGoals} Tore / ${stats.sevenMetersAttempted} Vers.)</p></div>
                        <div class="bg-white p-3 rounded-lg shadow"><p class="text-2xl font-bold">${stats.warnings}</p><p class="text-xs text-gray-500">Verwarn.</p></div>
                        <div class="bg-white p-3 rounded-lg shadow"><p class="text-2xl font-bold">${stats.suspensions}</p><p class="text-xs text-gray-500">2-Min</p></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8">
                    <div class="bg-gray-50 p-4 sm:p-6 rounded-lg border">
                        <h3 class="text-xl font-bold mb-4 text-indigo-700">Tor-Verlauf</h3>
                        <div class="relative h-64">
                           <canvas id="player-profile-chart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-lg border">
                         <h3 class="text-xl font-bold mb-4 text-indigo-700">Spieleliste</h3>
                         <div class="overflow-y-auto max-h-80">
                             <table class="min-w-full">
                                 <thead class="bg-gray-200 sticky top-0"><tr><th class="px-4 py-2 text-left text-sm">Datum</th><th class="px-4 py-2 text-left text-sm">Gegner</th><th class="px-4 py-2 text-left text-sm">Tore</th></tr></thead>
                                 <tbody class="divide-y">
                                 ${gamesWithPlayer.map(g => `<tr><td class="px-4 py-2 text-sm">${g.date}</td><td class="px-4 py-2 text-sm">${g.opponent}</td><td class="px-4 py-2 font-bold text-sm">${g.goals}</td></tr>`).join('')}
                                 </tbody>
                             </table>
                         </div>
                    </div>
                </div>
            `;
            playerProfileContainer.innerHTML = html;

            if (playerProfileChart) { playerProfileChart.destroy(); }
            const chartCanvas = document.getElementById('player-profile-chart');
            if(chartCanvas) {
                playerProfileChart = new Chart(chartCanvas, {
                    type: 'line',
                    data: {
                        labels: gamesWithPlayer.map((g, i) => `Spiel ${i+1}`),
                        datasets: [{
                            label: 'Tore pro Spiel',
                            data: gamesWithPlayer.map(g => g.goals),
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }
        }

        function populateH2hSelectors() {
            const teams = new Set();
            allGames.forEach(game => { 
                teams.add(getCorrectedName(game, game.homeTeam)); 
                teams.add(getCorrectedName(game, game.guestTeam)); 
            });
            const sortedTeams = [...teams].sort((a, b) => a.localeCompare(b));
            
            const currentTeam1 = h2hTeam1Select.value;
            const currentTeam2 = h2hTeam2Select.value;

            h2hTeam1Select.innerHTML = '<option value="">-- Team 1 --</option>';
            h2hTeam2Select.innerHTML = '<option value="">-- Team 2 --</option>';

            sortedTeams.forEach(team => {
                h2hTeam1Select.innerHTML += `<option value="${team}">${team}</option>`;
                h2hTeam2Select.innerHTML += `<option value="${team}">${team}</option>`;
            });

            if(sortedTeams.includes(currentTeam1)) h2hTeam1Select.value = currentTeam1;
            if(sortedTeams.includes(currentTeam2)) h2hTeam2Select.value = currentTeam2;
        }

        function renderH2hComparison() {
            const team1 = h2hTeam1Select.value;
            const team2 = h2hTeam2Select.value;

            if (!team1 || !team2) {
                h2hResultsContainer.innerHTML = `<p class="text-center text-gray-500">Bitte zwei Teams auswählen.</p>`;
                return;
            }
            if (team1 === team2) {
                h2hResultsContainer.innerHTML = `<p class="text-center text-gray-500">Bitte zwei unterschiedliche Teams auswählen.</p>`;
                return;
            }

            const matchups = allGames.filter(game => {
                const home = getCorrectedName(game, game.homeTeam);
                const guest = getCorrectedName(game, game.guestTeam);
                return (home === team1 && guest === team2) || (home === team2 && guest === team1);
            });

            if (matchups.length === 0) {
                h2hResultsContainer.innerHTML = `<p class="text-center text-gray-500">Keine direkten Begegnungen zwischen diesen Teams gefunden.</p>`;
                return;
            }

            let team1Wins = 0, team2Wins = 0, draws = 0;
            let team1Goals = 0, team2Goals = 0;

            matchups.forEach(game => {
                const [homeScore, guestScore] = game.finalScore.split(':').map(Number);
                const homeTeam = getCorrectedName(game, game.homeTeam);
                
                if (homeTeam === team1) {
                    team1Goals += homeScore;
                    team2Goals += guestScore;
                    if (homeScore > guestScore) team1Wins++;
                    else if (guestScore > homeScore) team2Wins++;
                    else draws++;
                } else { // homeTeam is team2
                    team2Goals += homeScore;
                    team1Goals += guestScore;
                    if (guestScore > homeScore) team1Wins++;
                    else if (homeScore > guestScore) team2Wins++;
                    else draws++;
                }
            });

            const avgGoals1 = (team1Goals / matchups.length).toFixed(2);
            const avgGoals2 = (team2Goals / matchups.length).toFixed(2);

            let html = `
                <div class="text-center bg-gray-50 p-4 sm:p-6 rounded-lg">
                    <h3 class="text-xl sm:text-2xl font-bold">${team1} vs ${team2}</h3>
                    <div class="mt-4 grid grid-cols-3 gap-4">
                        <div>
                            <p class="text-3xl sm:text-4xl font-bold text-green-600">${team1Wins}</p>
                            <p class="text-xs sm:text-sm text-gray-600">Siege ${team1}</p>
                        </div>
                        <div>
                            <p class="text-3xl sm:text-4xl font-bold text-yellow-600">${draws}</p>
                            <p class="text-xs sm:text-sm text-gray-600">Unentschieden</p>
                        </div>
                        <div>
                            <p class="text-3xl sm:text-4xl font-bold text-green-600">${team2Wins}</p>
                            <p class="text-xs sm:text-sm text-gray-600">Siege ${team2}</p>
                        </div>
                    </div>
                     <div class="mt-4 grid grid-cols-2 gap-4 border-t pt-4">
                        <div><p class="text-lg sm:text-xl font-bold">${avgGoals1}</p><p class="text-xs sm:text-sm">Ø Tore ${team1}</p></div>
                        <div><p class="text-lg sm:text-xl font-bold">${avgGoals2}</p><p class="text-xs sm:text-sm">Ø Tore ${team2}</p></div>
                    </div>
                </div>
                <div class="mt-6">
                    <h4 class="text-lg font-semibold mb-2">Spiel-Historie</h4>
                    <ul class="space-y-2">
                        ${matchups.map(game => `
                            <li class="p-3 bg-white border rounded-lg flex flex-col sm:flex-row justify-between sm:items-center text-sm gap-2">
                                <span class="font-semibold">${game.date}</span>
                                <span class="text-center">${getCorrectedName(game, game.homeTeam)} - ${getCorrectedName(game, game.guestTeam)}</span>
                                <span class="font-bold text-base">${game.finalScore}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
            h2hResultsContainer.innerHTML = html;
        }

        function renderSettings() {
            renderCustomRosterManagement();
        }

        // ===================================================================================
        // ===== FIREBASE COMMUNICATION BLOCK - START ========================================
        // ===================================================================================
        // HINWEIS: Der folgende Code-Abschnitt ist für die Verbindung und Kommunikation
        // mit der Firebase-Datenbank verantwortlich. Änderungen in diesem Bereich
        // können die Funktionalität der App beeinträchtigen. Bitte nicht verändern,
        // es sei denn, du weißt genau, was du tust.
        // ===================================================================================

        // --- Globale Firebase-Variablen ---
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let gamesCollectionRef = null;
        let customRostersCollectionRef = null;
        let unsubscribeFromGames = null;
        let unsubscribeFromCustomRosters = null;
        let appId;

        // --- Haupt-Initialisierungsfunktion für Firebase ---
        async function initializeAppAndAuth() {
            console.log("Starting Firebase initialization...");
            connectionStatusDot.className = 'w-3 h-3 rounded-full status-dot-checking';
            connectionStatusText.textContent = 'Verbinde...';
            
            // Feste Firebase-Konfiguration für den Zugriff auf deine spezifische Datenbank.
            const firebaseConfig = {
              apiKey: "AIzaSyBzvp7Gor7qzDn78QoVEHU-vwG7imY4xKw",
              authDomain: "sgbdmb2425.firebaseapp.com",
              projectId: "sgbdmb2425",
              storageBucket: "sgbdmb2425.appspot.com",
              messagingSenderId: "132227886986",
              appId: "1:132227886986:web:0499501f444fdc10b12273",
              measurementId: "G-9NKRXVDLBV"
            };
            appId = firebaseConfig.appId;

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase App initialized with original hardcoded config.");

                // Datenbank-Pfade. Alle Daten werden öffentlich unter der App-ID gespeichert.
                gamesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'games');
                customRostersCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'custom-rosters');
                
                console.log("Using database path for games:", gamesCollectionRef.path);
                console.log("Using database path for custom rosters:", customRostersCollectionRef.path);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Auth state changed: User is signed in with UID:", user.uid);
                        userId = user.uid; 
                        isAuthReady = true;
                        connectionStatusDot.className = 'w-3 h-3 rounded-full status-dot-connected';
                        connectionStatusText.textContent = 'Verbunden';
                        
                        // Start listening to data once authenticated
                        listenForGames(); 
                        listenForCustomRosters();
                    } else {
                        console.log("Auth state changed: User is signed out.");
                        isAuthReady = false;
                        userId = null;
                        if(unsubscribeFromGames) unsubscribeFromGames();
                        if(unsubscribeFromCustomRosters) unsubscribeFromCustomRosters();
                        allGames = [];
                        allCustomRosters = [];
                        connectionStatusDot.className = 'w-3 h-3 rounded-full status-dot-disconnected';
                        connectionStatusText.textContent = 'Nicht verbunden';
                        updateDynamicContent();
                    }
                });
                
                // Anonyme Anmeldung
                console.log("Attempting to sign in anonymously...");
                await signInAnonymously(auth);
                console.log("Sign in anonymously successful.");

            } catch (error) {
                console.error("Error during Firebase initialization or authentication:", error);
                gameArchiveList.innerHTML = `<p class="text-red-500 p-4">Fehler bei der Initialisierung von Firebase. Prüfen Sie die Konsolenausgabe.</p>`;
                connectionStatusDot.className = 'w-3 h-3 rounded-full status-dot-disconnected';
                connectionStatusText.textContent = 'Initialisierungsfehler';
            }
        }
        
        // --- Firebase Real-time Listener ---
        function listenForGames() {
            if (unsubscribeFromGames) unsubscribeFromGames();
            if (!gamesCollectionRef) return;
            unsubscribeFromGames = onSnapshot(gamesCollectionRef, snapshot => {
                const gamesFromDb = snapshot.docs.map(doc => doc.data());
                allGames = gamesFromDb.sort((a, b) => new Date(b.date.split('.').reverse().join('-')).getTime() - new Date(a.date.split('.').reverse().join('-')).getTime());
                console.log('Games data loaded/updated:', allGames.length);
                updateDynamicContent();
            }, error => console.error("Error listening to games collection:", error));
        }

        function listenForCustomRosters() {
            if(unsubscribeFromCustomRosters) unsubscribeFromCustomRosters();
            if(!customRostersCollectionRef) return;
            unsubscribeFromCustomRosters = onSnapshot(customRostersCollectionRef, snapshot => {
                allCustomRosters = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('Custom rosters loaded/updated:', allCustomRosters.length);
                if(views.einstellungen.classList.contains('view-active')) renderCustomRosterManagement();
            }, error => console.error("Error listening to custom rosters:", error));
        }

        // ===================================================================================
        // ===== FIREBASE COMMUNICATION BLOCK - END ==========================================
        // ===================================================================================

        // --- CUSTOM ROSTER FUNCTIONS ---
        function renderCustomRosterManagement() {
            if (!customRosterManagementContainer) return;

            let html = `
                <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-indigo-700">Kader Archiv</h3>
                    <div class="flex gap-2">
                        <button id="import-roster-archive-btn" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 transition text-sm">Archiv importieren</button>
                        <button id="create-custom-roster-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition">Neuen Kader anlegen</button>
                    </div>
                </div>
            `;

            if (allCustomRosters.length > 0) {
                html += '<ul class="space-y-2">';
                allCustomRosters.forEach(roster => {
                    html += `
                        <li class="p-3 bg-white border rounded-lg flex justify-between items-center">
                            <span class="font-semibold">${roster.name}</span>
                            <div class="flex items-center space-x-1 shrink-0">
                                <button data-roster-id="${roster.id}" class="export-single-roster-btn p-2 text-gray-400 hover:text-cyan-500 rounded-full hover:bg-cyan-100" title="Diesen Kader exportieren">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M10 3a1 1 0 011 1v5.586l2.293-2.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 9.586V4a1 1 0 011-1z" />
                                        <path d="M3 12a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" />
                                    </svg>
                                </button>
                                <button data-roster-id="${roster.id}" class="edit-custom-roster-btn p-2 text-gray-400 hover:text-blue-500 rounded-full hover:bg-blue-100" title="Kader bearbeiten">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                </button>
                                <button data-roster-id="${roster.id}" data-roster-name="${roster.name}" class="delete-custom-roster-btn p-2 text-gray-400 hover:text-red-500 rounded-full hover:bg-red-100" title="Kader löschen">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                        </li>
                    `;
                });
                html += '</ul>';
            } else {
                html += '<p class="text-gray-500 mt-4">Noch keine Kader im Archiv.</p>';
            }
            
            customRosterManagementContainer.innerHTML = html;

            // Add event listeners
            document.getElementById('create-custom-roster-btn').addEventListener('click', () => openCustomRosterModal());
            document.getElementById('import-roster-archive-btn').addEventListener('click', () => importRosterArchiveInput.click());
            document.querySelectorAll('.export-single-roster-btn').forEach(btn => btn.addEventListener('click', (e) => exportSingleCustomRoster(e.currentTarget.dataset.rosterId)));
            document.querySelectorAll('.edit-custom-roster-btn').forEach(btn => btn.addEventListener('click', (e) => openCustomRosterModal(e.currentTarget.dataset.rosterId)));
            document.querySelectorAll('.delete-custom-roster-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const rosterId = e.currentTarget.dataset.rosterId;
                const rosterName = e.currentTarget.dataset.rosterName;
                showConfirmation(`Möchtest du den Kader "${rosterName}" wirklich löschen?`, () => deleteCustomRoster(rosterId));
            }));
        }
        
        function openCustomRosterModal(rosterId = null) {
            currentlyEditingCustomRosterId = rosterId;
            customRosterEditor.innerHTML = '';

            if (rosterId) {
                const rosterData = allCustomRosters.find(r => r.id === rosterId);
                if (!rosterData) return;
                customRosterModalTitle.textContent = "Kader bearbeiten";
                customRosterNameInput.value = rosterData.name;
                const sortedPlayers = Object.entries(rosterData.roster || {}).sort((a,b) => parseInt(a[0]) - parseInt(b[0]));
                sortedPlayers.forEach(([number, name]) => addPlayerToCustomRosterUI(number, name));
            } else {
                customRosterModalTitle.textContent = "Neuen Kader anlegen";
                customRosterNameInput.value = '';
                addPlayerToCustomRosterUI('', ''); // Start with one empty row
            }
            customRosterModal.classList.add('flex');
        }

        function addPlayerToCustomRosterUI(number = '', name = '') {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2 custom-roster-player-row';
            div.innerHTML = `
                <input type="number" value="${number}" placeholder="Nr." class="custom-roster-number w-20 p-2 border rounded-md">
                <input type="text" value="${name}" placeholder="Name" class="custom-roster-name flex-grow p-2 border rounded-md">
                <button class="remove-custom-player-btn p-2 text-red-500 hover:bg-red-100 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            `;
            customRosterEditor.appendChild(div);
            div.querySelector('.remove-custom-player-btn').addEventListener('click', () => div.remove());
        }

        async function saveCustomRoster() {
            const name = customRosterNameInput.value.trim();
            if (!name) {
                showNotification("Bitte einen Kadernamen eingeben.", "error");
                return;
            }

            const playerRows = customRosterEditor.querySelectorAll('.custom-roster-player-row');
            const roster = {};
            let hasError = false;
            playerRows.forEach(row => {
                const number = row.querySelector('.custom-roster-number').value.trim();
                const playerName = row.querySelector('.custom-roster-name').value.trim();
                if (number && playerName) {
                    if (roster[number]) {
                        hasError = true;
                    }
                    roster[number] = playerName;
                }
            });

            if (hasError) {
                showNotification("Jede Spielernummer darf nur einmal vorkommen.", "error");
                return;
            }

            const dataToSave = { name, roster };

            try {
                if (currentlyEditingCustomRosterId) {
                    const docRef = doc(customRostersCollectionRef, currentlyEditingCustomRosterId);
                    await updateDoc(docRef, dataToSave);
                    showNotification("Kader erfolgreich aktualisiert.", "success");
                } else {
                    await addDoc(customRostersCollectionRef, dataToSave);
                    showNotification("Kader erfolgreich erstellt.", "success");
                }
                customRosterModal.classList.remove('flex');
            } catch (error) {
                console.error("Error saving custom roster:", error);
                showNotification("Fehler beim Speichern des Kaders.", "error");
            }
        }

        async function deleteCustomRoster(rosterId) {
            if (!isAuthReady || !customRostersCollectionRef) return;
            try {
                await deleteDoc(doc(customRostersCollectionRef, rosterId));
                showNotification("Kader erfolgreich gelöscht.", "success");
            } catch (error) {
                console.error("Error deleting custom roster:", error);
                showNotification("Kader konnte nicht gelöscht werden.", "error");
            }
        }
        
        function exportSingleCustomRoster(rosterId) {
            const rosterToExport = allCustomRosters.find(r => r.id === rosterId);
            if (!rosterToExport) {
                showNotification("Der zu exportierende Kader wurde nicht gefunden.", "error");
                return;
            }

            const { id, ...dataToExport } = rosterToExport;
            
            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            const safeFilename = rosterToExport.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            a.download = `kader_export_${safeFilename}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification(`Kader "${rosterToExport.name}" wird exportiert...`, "success");
        }

        async function importCustomRosters(event) {
            if (!isAuthReady || !customRostersCollectionRef) {
                showNotification("Datenbank ist nicht bereit.", "error");
                return;
            }
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedRosters = JSON.parse(e.target.result);
                    if (!Array.isArray(importedRosters)) { throw new Error("Importierte Datei hat kein gültiges Format (Array erwartet)."); }
                    
                    showNotification(`Importiere ${importedRosters.length} Kader...`, 'info');
                    
                    const batch = writeBatch(db);
                    importedRosters.forEach(roster => {
                        // Basic validation for a roster object
                        if (roster && typeof roster.name === 'string' && typeof roster.roster === 'object') {
                            const docRef = doc(customRostersCollectionRef); // Create a new document reference for each roster
                            batch.set(docRef, roster);
                        }
                    });
                    
                    await batch.commit();
                    showNotification(`Import erfolgreich! ${importedRosters.length} Kader wurden zum Archiv hinzugefügt.`, 'success');
                } catch (error) {
                    console.error("Roster Import Error:", error);
                    showNotification(`Fehler beim Import des Kader-Archivs: ${error.message}`, 'error');
                } finally {
                    importRosterArchiveInput.value = ''; // Reset file input
                }
            };
            reader.readAsText(file);
        }


        // --- STARTUP ---
        document.addEventListener('DOMContentLoaded', () => {
            setupUI();
            initializeAppAndAuth();
        });

    </script>

</body>
</html>
