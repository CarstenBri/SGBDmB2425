<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handball Saison Analysator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active { border-bottom-color: #4f46e5; color: #4f46e5; }
        .detail-tab-active { background-color: #eef2ff; color: #4f46e5; }
        .view { display: none; }
        .view-active { display: block; }
        .detail-view-content { display: none; }
        .detail-view-content-active { display: block; }
        .clickable-player { cursor: pointer; text-decoration: underline; text-decoration-color: #a5b4fc; }
        .clickable-player:hover { text-decoration-color: #4f46e5; }
        #connection-status-container { cursor: pointer; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .view-active { animation: fadeIn 0.3s ease-in-out; }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal.flex { display: flex; }
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            z-index: 110;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
        }
        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .notification.bg-success { background-color: #28a745; }
        .notification.bg-error { background-color: #dc3545; }
        .notification.bg-info { background-color: #17a2b8; }

        .status-dot-connected { background-color: #28a745; }
        .status-dot-disconnected { background-color: #dc3545; }
        .status-dot-checking { background-color: #ffc107; }
        .status-dot-unknown { background-color: #6c757d; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="bg-white rounded-xl shadow-md p-6 mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-600">Handball Saison Analysator</h1>
            <p class="text-gray-600 mt-2">Füge Spieldaten ein, archiviere sie und analysiere die Leistung von Teams und Spielern.</p>
        </header>

        <div class="mb-6 border-b border-gray-200">
            <nav class="flex space-x-4 overflow-x-auto pb-2">
                <button id="tab-eingabe" class="tab-btn px-4 py-3 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-gray-300 shrink-0">Spieldaten eingeben</button>
                <button id="tab-archiv" class="tab-btn px-4 py-3 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-gray-300 shrink-0">Archivierte Spiele</button>
                <button id="tab-statistik" class="tab-btn px-4 py-3 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-gray-300 shrink-0">Team-Statistiken</button>
                <button id="tab-spieler" class="tab-btn px-4 py-3 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-gray-300 shrink-0">Spieler-Profile</button>
                <button id="tab-h2h" class="tab-btn px-4 py-3 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-gray-300 shrink-0">H2H-Vergleich</button>
            </nav>
        </div>

        <main>
            <div id="view-eingabe" class="view">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="eingabe-title" class="text-2xl font-bold">Neues Spiel hinzufügen</h2>
                        <button id="process-and-save-btn" class="bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
                            Spiel analysieren & hinzufügen
                        </button>
                    </div>
                    <p class="mb-4 text-gray-600">Kopiere den kompletten "Presseinformation - lang" Text aus handball4all hier hinein.</p>
                    <textarea id="game-data-input" rows="15" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Hier die Spieldaten einfügen..."></textarea>
                    <button id="cancel-edit-btn" class="mt-4 w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition" style="display: none;">
                        Abbrechen
                    </button>
                    <div id="input-status" class="mt-4 text-center"></div>
                </div>
            </div>

            <div id="view-archiv" class="view">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4 gap-4">
                        <h2 class="text-2xl font-bold shrink-0">Archivierte Spiele</h2>
                        <div class="w-full flex flex-col sm:flex-row gap-4">
                            <input type="text" id="archive-search-input" placeholder="Nach Team filtern..." class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 w-full sm:w-auto sm:flex-grow">
                            <div class="flex items-center space-x-2 shrink-0">
                                <button id="export-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition">Alle exportieren</button>
                                <button id="import-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition">Importieren</button>
                                <input type="file" id="import-file-input" class="hidden" accept=".json">
                            </div>
                        </div>
                    </div>
                    <div id="import-status" class="mb-4 text-center"></div>
                    <p class="text-sm text-gray-500 mb-4">Klicke auf ein Spiel, um die Auswertungen anzuzeigen.</p>
                    <div id="game-archive-list" class="space-y-2"></div>
                </div>
            </div>
            
            <div id="view-game-detail" class="view">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div id="game-detail-header" class="flex justify-between items-start mb-4 flex-wrap gap-4">
                        <div>
                            <h2 id="game-detail-title" class="text-2xl font-bold">Spieldetails</h2>
                            <p id="game-detail-subtitle" class="text-gray-600"></p>
                        </div>
                        <div class="flex space-x-2">
                            <button id="export-image-btn" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 transition">Grafik exportieren</button>
                            <button id="edit-game-btn" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 transition">Bearbeiten</button>
                            <button class="back-to-archive-btn bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition">Zurück zum Archiv</button>
                        </div>
                    </div>

                    <div class="my-6 p-4 bg-gray-50 rounded-lg flex items-center justify-between gap-4">
                        <button id="prev-game-btn" class="p-2 rounded-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        </button>
                        <select id="game-nav-select" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></select>
                        <button id="next-game-btn" class="p-2 rounded-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>

                    <div class="border-b border-gray-200 mb-6">
                        <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                            <button id="detail-tab-graphical" class="detail-tab-btn whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm">Grafische Auswertung</button>
                            <button id="detail-tab-tabular" class="detail-tab-btn whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm">Tabellarische Auswertung</button>
                        </nav>
                    </div>

                    <div id="detail-content-graphical" class="detail-view-content">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="md:col-span-2 space-y-6">
                                <div class="p-4 bg-gray-50 rounded-lg"><canvas id="score-chart"></canvas></div>
                                <div class="p-4 bg-gray-50 rounded-lg"><canvas id="scoring-run-chart"></canvas></div>
                            </div>
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <h3 class="font-bold mb-2 text-gray-700">Torschützen</h3>
                                <div id="player-goal-list" class="space-y-1" style="max-height: 70vh; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>

                    <div id="detail-content-tabular" class="detail-view-content">
                         <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                            <div><h2 class="text-2xl font-bold">Tabellarische Auswertung</h2></div>
                            <button id="correct-names-btn" class="bg-purple-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-600 transition">Namen korrigieren</button>
                        </div>
                        <div id="tabular-content-container" class="space-y-8"></div>
                    </div>
                </div>
            </div>

            <div id="view-statistik" class="view">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Team-Statistiken</h2>
                    <div class="mb-6">
                        <label for="team-select" class="block text-sm font-medium text-gray-700 mb-2">Team für die Analyse auswählen:</label>
                        <select id="team-select" class="w-full md:w-1/2 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                    <div id="stats-container" class="space-y-8">
                        <p id="stats-placeholder" class="text-gray-500">Bitte ein Team auswählen, um die Statistiken anzuzeigen.</p>
                    </div>
                </div>
            </div>

            <div id="view-spieler" class="view">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Spieler-Profile</h2>
                    <div class="mb-6">
                        <label for="player-select" class="block text-sm font-medium text-gray-700 mb-2">Spieler für die Analyse auswählen:</label>
                        <select id="player-select" class="w-full md:w-1/2 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                    <div id="player-profile-container" class="space-y-8">
                        <p id="player-profile-placeholder" class="text-gray-500">Bitte einen Spieler auswählen, um das Profil anzuzeigen.</p>
                    </div>
                </div>
            </div>

            <div id="view-h2h" class="view">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Head-to-Head (H2H) Vergleich</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="h2h-team1-select" class="block text-sm font-medium text-gray-700 mb-1">Team 1</label>
                            <select id="h2h-team1-select" class="w-full p-2 border border-gray-300 rounded-lg"></select>
                        </div>
                        <div>
                            <label for="h2h-team2-select" class="block text-sm font-medium text-gray-700 mb-1">Team 2</label>
                            <select id="h2h-team2-select" class="w-full p-2 border border-gray-300 rounded-lg"></select>
                        </div>
                        <button id="h2h-compare-btn" class="w-full md:w-auto bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Vergleichen</button>
                    </div>
                    <div id="h2h-results-container" class="mt-8 space-y-6"></div>
                </div>
            </div>

        </main>
        
        <footer class="text-center text-sm text-gray-500 mt-12 pb-4">
            <p>Handball Saison Analysator | Version <span id="app-version"></span></p>
            <div id="connection-status-container" class="flex items-center justify-center space-x-2 mt-2 hover:bg-gray-200 p-2 rounded-md transition">
                <div id="connection-status-dot" class="w-3 h-3 rounded-full status-dot-unknown transition-colors"></div>
                <span id="connection-status-text" class="text-sm text-gray-600">Verbindungsstatus unbekannt</span>
            </div>
        </footer>
    </div>
    
    <div id="name-correction-modal" class="modal">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full mx-4">
            <h3 class="text-lg font-bold mb-4">Spielernamen korrigieren</h3>
            <div id="name-correction-list" class="space-y-2 max-h-96 overflow-y-auto mb-6"></div>
            <div class="flex justify-between space-x-4">
                <button id="name-correction-apply-all" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600">Alle Kader-Namen übernehmen</button>
                <div class="flex space-x-4">
                    <button id="name-correction-cancel" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700">Abbrechen</button>
                    <button id="name-correction-save" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Korrekturen speichern</button>
                </div>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="modal">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full mx-4 text-center">
            <h3 class="text-xl font-bold mb-4">Bestätigung</h3>
            <p id="confirmation-message" class="text-gray-600 mb-6">Möchten Sie diese Aktion wirklich durchführen?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">Abbrechen</button>
                <button id="confirm-ok-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Bestätigen</button>
            </div>
        </div>
    </div>

    <div id="connection-details-modal" class="modal">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-lg w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Verbindungsdetails</h3>
                <button id="connection-modal-close-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div class="space-y-3 text-sm">
                <div class="flex justify-between border-b pb-2">
                    <span class="font-semibold text-gray-600">Status:</span>
                    <span id="modal-connection-status" class="font-mono">-</span>
                </div>
                <div class="flex justify-between border-b pb-2">
                    <span class="font-semibold text-gray-600">App ID:</span>
                    <span id="modal-app-id" class="font-mono break-all">-</span>
                </div>
                <div class="flex justify-between border-b pb-2">
                    <span class="font-semibold text-gray-600">User ID:</span>
                    <span id="modal-user-id" class="font-mono break-all">-</span>
                </div>
            </div>
        </div>
    </div>


    <div id="notification" class="notification"></div>

    <script type="module">
        // Firebase Modular SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, writeBatch } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        
        // --- CONFIG & INITIALIZATION ---
        const APP_VERSION = "3.4.0-firebase";

        // Firebase instances
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let gamesCollectionRef = null;
        let appId;

        const SG_BUENDE_DUENNE = "SG Bünde-Dünne";
        const STANDARD_ROSTER_SGBD = {
            2: 'Finn Diekmann', 3: 'Ben Wienecke', 4: 'Mika Fleischer', 5: 'Johannes Müller',
            7: 'Karl-Moritz Westphal', 8: 'Erik Meier', 9: 'Jannes Westerheide', 10: 'Nico Schneidmiller',
            11: 'Henrik Link', 12: 'Alex Dekanoidze', 13: 'Conner Brinkmeyer', 15: 'Finn Heinze',
            16: 'Tom Gieselmann', 17: 'Silas Peitzmann', 18: 'Fynn Rottmann'
        };
        
        // Global state variables
        let allGames = [];
        let unsubscribeFromGames = null;
        let currentlyEditingGameId = null;
        let scoreChart = null;
        let scoringRunChart = null;
        let playerProfileChart = null;
        let selectedPlayers = [];

        // --- DOM ELEMENTS ---
        const views = {
            eingabe: document.getElementById('view-eingabe'), 
            archiv: document.getElementById('view-archiv'),
            statistik: document.getElementById('view-statistik'), 
            gameDetail: document.getElementById('view-game-detail'),
            spieler: document.getElementById('view-spieler'),
            h2h: document.getElementById('view-h2h'),
        };
        const tabs = {
            eingabe: document.getElementById('tab-eingabe'), 
            archiv: document.getElementById('tab-archiv'),
            statistik: document.getElementById('tab-statistik'),
            spieler: document.getElementById('tab-spieler'),
            h2h: document.getElementById('tab-h2h'),
        };
        const gameDataInput = document.getElementById('game-data-input');
        const processBtn = document.getElementById('process-and-save-btn');
        const cancelBtn = document.getElementById('cancel-edit-btn');
        const eingabeTitle = document.getElementById('eingabe-title');
        const inputStatus = document.getElementById('input-status');
        const gameArchiveList = document.getElementById('game-archive-list');
        const archiveSearchInput = document.getElementById('archive-search-input');
        const teamSelect = document.getElementById('team-select');
        const statsContainer = document.getElementById('stats-container');
        const statsPlaceholder = document.getElementById('stats-placeholder');
        const appVersionDisplay = document.getElementById('app-version');
        const gameDetailTitle = document.getElementById('game-detail-title');
        const gameDetailSubtitle = document.getElementById('game-detail-subtitle');
        const scoreChartCanvas = document.getElementById('score-chart');
        const scoringRunChartCanvas = document.getElementById('scoring-run-chart');
        const editGameBtn = document.getElementById('edit-game-btn');
        const playerGoalList = document.getElementById('player-goal-list');
        const tabularContentContainer = document.getElementById('tabular-content-container');
        const backToArchiveBtns = document.querySelectorAll('.back-to-archive-btn');
        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const importFileInput = document.getElementById('import-file-input');
        const importStatus = document.getElementById('import-status');
        const correctNamesBtn = document.getElementById('correct-names-btn');
        const nameCorrectionModal = document.getElementById('name-correction-modal');
        const nameCorrectionList = document.getElementById('name-correction-list');
        const nameCorrectionSaveBtn = document.getElementById('name-correction-save');
        const nameCorrectionCancelBtn = document.getElementById('name-correction-cancel');
        const nameCorrectionApplyAllBtn = document.getElementById('name-correction-apply-all');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessage = document.getElementById('confirmation-message');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const notificationElement = document.getElementById('notification');
        const connectionStatusContainer = document.getElementById('connection-status-container');
        const connectionStatusDot = document.getElementById('connection-status-dot');
        const connectionStatusText = document.getElementById('connection-status-text');
        const detailTabGraphical = document.getElementById('detail-tab-graphical');
        const detailTabTabular = document.getElementById('detail-tab-tabular');
        const detailContentGraphical = document.getElementById('detail-content-graphical');
        const detailContentTabular = document.getElementById('detail-content-tabular');
        const gameNavSelect = document.getElementById('game-nav-select');
        const prevGameBtn = document.getElementById('prev-game-btn');
        const nextGameBtn = document.getElementById('next-game-btn');
        const exportImageBtn = document.getElementById('export-image-btn');
        const playerSelect = document.getElementById('player-select');
        const playerProfileContainer = document.getElementById('player-profile-container');
        const playerProfilePlaceholder = document.getElementById('player-profile-placeholder');
        const h2hTeam1Select = document.getElementById('h2h-team1-select');
        const h2hTeam2Select = document.getElementById('h2h-team2-select');
        const h2hCompareBtn = document.getElementById('h2h-compare-btn');
        const h2hResultsContainer = document.getElementById('h2h-results-container');
        const connectionDetailsModal = document.getElementById('connection-details-modal');
        const connectionModalCloseBtn = document.getElementById('connection-modal-close-btn');
        const modalConnectionStatus = document.getElementById('modal-connection-status');
        const modalAppId = document.getElementById('modal-app-id');
        const modalUserId = document.getElementById('modal-user-id');

        // --- UI & VIEW MANAGEMENT ---
        function setupUI() {
            appVersionDisplay.textContent = APP_VERSION;
            Object.keys(tabs).forEach(key => {
                tabs[key].addEventListener('click', () => switchView(key));
            });
            processBtn.addEventListener('click', handleProcessAndSaveGame);
            teamSelect.addEventListener('change', renderStatistics);
            playerSelect.addEventListener('change', () => renderPlayerProfile(playerSelect.value));
            cancelBtn.addEventListener('click', resetToNewEntryMode);
            
            backToArchiveBtns.forEach(btn => btn.addEventListener('click', () => switchView('archiv')));
            
            editGameBtn.addEventListener('click', () => {
                if (currentlyEditingGameId) startEditing(currentlyEditingGameId);
            });
            exportBtn.addEventListener('click', exportGames);
            importBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', importGames);
            correctNamesBtn.addEventListener('click', openNameCorrectionModal);
            nameCorrectionSaveBtn.addEventListener('click', saveNameCorrections);
            nameCorrectionCancelBtn.addEventListener('click', () => nameCorrectionModal.classList.remove('flex'));
            nameCorrectionApplyAllBtn.addEventListener('click', applyAllRosterNames);
            
            nameCorrectionList.addEventListener('click', (event) => {
                if (event.target.classList.contains('kadername-btn')) {
                    const button = event.target;
                    const playerNumber = button.dataset.playerNumber;
                    const standardName = STANDARD_ROSTER_SGBD[playerNumber];
                    if (standardName) {
                        const inputField = button.closest('.player-correction-item').querySelector('input');
                        if (inputField) inputField.value = standardName;
                    } else {
                        showNotification(`Kein Kadername für Spieler #${playerNumber} gefunden.`, 'info');
                    }
                }
            });

            document.body.addEventListener('click', (event) => {
                if(event.target.classList.contains('clickable-player')) {
                    const playerName = event.target.dataset.playerName;
                    if(playerName) {
                        renderPlayerProfile(playerName, true);
                    }
                }
            });

            gameArchiveList.addEventListener('click', (event) => {
                const gameButton = event.target.closest('.game-entry-btn');
                const deleteButton = event.target.closest('.delete-game-btn');

                if (deleteButton) {
                    event.stopPropagation();
                    const gameId = deleteButton.dataset.gameId;
                    showConfirmation(`Möchtest du das Spiel wirklich löschen?`, () => deleteGame(gameId));
                } else if (gameButton) {
                    renderGameDetail(gameButton.dataset.gameId);
                }
            });

            playerGoalList.addEventListener('click', (event) => {
                const playerButton = event.target.closest('.player-goal-btn');
                if (playerButton) {
                    const playerName = playerButton.dataset.playerName;
                    const game = allGames.find(g => g.id === currentlyEditingGameId);
                    if (selectedPlayers.includes(playerName)) {
                        selectedPlayers = selectedPlayers.filter(p => p !== playerName);
                        playerButton.classList.remove('bg-indigo-500', 'text-white');
                    } else {
                        selectedPlayers.push(playerName);
                        playerButton.classList.add('bg-indigo-500', 'text-white');
                    }
                    updateChartWithSelectedPlayers(game);
                }
            });
            
            connectionStatusContainer.addEventListener('click', showConnectionDetailsModal);
            connectionModalCloseBtn.addEventListener('click', () => connectionDetailsModal.classList.remove('flex'));
            detailTabGraphical.addEventListener('click', () => switchDetailView('graphical'));
            detailTabTabular.addEventListener('click', () => switchDetailView('tabular'));
            gameNavSelect.addEventListener('change', (e) => renderGameDetail(e.target.value));
            prevGameBtn.addEventListener('click', navigateToPreviousGame);
            nextGameBtn.addEventListener('click', navigateToNextGame);
            exportImageBtn.addEventListener('click', exportDetailAsImage);
            archiveSearchInput.addEventListener('input', () => renderArchiveList());
            h2hCompareBtn.addEventListener('click', renderH2hComparison);

            gameDataInput.value = `Presseinformation - lang
OWLmB-KL1, Spiel Nr. 621114216 am 28.09.24
Heim - Gast SG Bünde-Dünne - HSG Hüllhorst II
Ergebnis 30:25 (15:12)
... (füge hier den Rest des Berichts ein)`;
            
            switchView('eingabe');
        }
        
        function switchView(viewName) {
            if (currentlyEditingGameId && !['eingabe', 'gameDetail'].includes(viewName)) {
                resetToNewEntryMode();
            }
            Object.values(views).forEach(view => view.classList.remove('view-active'));
            Object.values(tabs).forEach(tab => tab.classList.remove('tab-active'));

            if (views[viewName]) {
                views[viewName].classList.add('view-active');
            }
            if (tabs[viewName]) {
                tabs[viewName].classList.add('tab-active');
            } else {
                tabs.archiv.classList.add('tab-active');
            }
        }

        function switchDetailView(detailViewName) {
            if (detailViewName === 'graphical') {
                detailTabGraphical.classList.add('border-indigo-500', 'text-indigo-600');
                detailTabGraphical.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                detailTabTabular.classList.remove('border-indigo-500', 'text-indigo-600');
                detailTabTabular.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                
                detailContentGraphical.style.display = 'block';
                detailContentTabular.style.display = 'none';
            } else if (detailViewName === 'tabular') {
                detailTabTabular.classList.add('border-indigo-500', 'text-indigo-600');
                detailTabTabular.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                detailTabGraphical.classList.remove('border-indigo-500', 'text-indigo-600');
                detailTabGraphical.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');

                detailContentGraphical.style.display = 'none';
                detailContentTabular.style.display = 'block';
            }
        }

        function startEditing(gameId) {
            const gameToEdit = allGames.find(g => g.id === gameId);
            if (!gameToEdit) return;

            currentlyEditingGameId = gameId;
            gameDataInput.value = gameToEdit.rawText;
            
            eingabeTitle.textContent = `Spiel bearbeiten (ID: ${gameId})`;
            processBtn.textContent = 'Änderungen speichern';
            processBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            processBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            cancelBtn.style.display = 'block';

            switchView('eingabe');
        }

        function resetToNewEntryMode() {
            currentlyEditingGameId = null;
            gameDataInput.value = '';
            inputStatus.innerHTML = '';
            
            eingabeTitle.textContent = 'Neues Spiel hinzufügen';
            processBtn.textContent = 'Spiel analysieren & hinzufügen';
            processBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            processBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            cancelBtn.style.display = 'none';
        }

        function showConfirmation(message, onConfirm) {
            confirmationMessage.textContent = message;
            confirmationModal.classList.add('flex');

            const confirmHandler = () => {
                confirmationModal.classList.remove('flex');
                onConfirm();
                confirmOkBtn.removeEventListener('click', confirmHandler);
                confirmCancelBtn.removeEventListener('click', cancelHandler);
            };

            const cancelHandler = () => {
                confirmationModal.classList.remove('flex');
                confirmOkBtn.removeEventListener('click', confirmHandler);
                confirmCancelBtn.removeEventListener('click', cancelHandler);
            };

            confirmOkBtn.addEventListener('click', confirmHandler);
            confirmCancelBtn.addEventListener('click', cancelHandler);
        }

        function showNotification(message, type = 'info') {
            notificationElement.textContent = message;
            notificationElement.className = `notification bg-${type}`;
            notificationElement.classList.add('show');
            setTimeout(() => {
                notificationElement.classList.remove('show');
            }, 3000);
        }

        function showConnectionDetailsModal() {
            modalAppId.textContent = appId || 'N/A';
            modalUserId.textContent = userId || 'N/A';
            modalConnectionStatus.textContent = connectionStatusText.textContent;
            connectionDetailsModal.classList.add('flex');
        }

        // --- DATA PARSING & FORMATTING ---
        function formatRawTextForEditing(rawText) {
            if (!rawText) return '';
            let text = rawText.trim();
            text = text.replace(/\r\n/g, '\n');
            text = text.replace(/([^\n])\n(Mannschaftslisten|Spielverlauf|Gast:)/g, '$1\n\n$2');
            return text;
        }

        function cleanReport(text) {
            const pageMarkerRegex = /Handball4all AG Seite \d\/\d.*?\n/g;
            return text.split(pageMarkerRegex).map((part, index) => {
                if (index === 0) return part;
                return part.replace(/Presseinformation - lang\n.*?\n/, '');
            }).join('');
        }

        function parsePlayerList(rosterSection) {
            const players = [];
            const lines = rosterSection.split('\n');
            for (const line of lines) {
                if (!/^\s*\d+\s/.test(line) || /\d{2}:\d{2}:\d{2}/.test(line) || line.includes("Jahrgang") || line.includes("Disq.")) {
                    continue;
                }
                const parts = line.trim().split(/\s+/).filter(Boolean);
                if (parts.length < 2) continue;
                const number = parseInt(parts[0]);
                if (isNaN(number)) continue;
                let goals = 0, sevenMeterGoals = 0, sevenMetersAttempted = 0, warnings = 0, suspensions = 0;
                let nameEndIndex = parts.length;
                let timeStampCount = 0;
                for (let i = parts.length - 1; i > 0; i--) {
                    if (/\d{1,2}:\d{2}/.test(parts[i])) {
                        timeStampCount++;
                        nameEndIndex = i;
                    } else { break; }
                }
                if (timeStampCount > 0) warnings = 1;
                if (timeStampCount > 1) suspensions = timeStampCount - 1;
                if (nameEndIndex > 1 && /\d+\/\d+/.test(parts[nameEndIndex - 1])) {
                    [sevenMeterGoals, sevenMetersAttempted] = parts[nameEndIndex - 1].split('/').map(Number);
                    nameEndIndex--;
                }
                if (nameEndIndex > 1 && /^\d+$/.test(parts[nameEndIndex - 1])) {
                    goals = parseInt(parts[nameEndIndex - 1]);
                    nameEndIndex--;
                }
                const namePart = parts.slice(1, nameEndIndex).join(' ').replace(/N\.N\./g, '').trim();
                let uniqueIdentifier = namePart || `Spieler #${number}`;
                players.push({ number, name: uniqueIdentifier, goals, sevenMeterGoals, sevenMetersAttempted, warnings, suspensions });
            }
            return players;
        }

        function timeToMinutes(timeStr) {
            const [minutes, seconds] = timeStr.split(':').map(Number);
            return minutes + seconds / 60;
        }
        
        function parseEventsFromLog(logSection, homeTeam, guestTeam, homePlayerMap, guestPlayerMap) {
            const goalEvents = [];
            const scoreProgression = [{time: '00:00', timeValue: 0, score: [0, 0]}];
            if (!logSection) return { goalEvents, scoreProgression };
            const lines = logSection.split('\n');
            const goalRegex = /\d{2}:\d{2}:\d{2}\s+(\d{2}:\d{2})\s+(\d+:\d+)\s+((7m-)?Tor) durch (.*)/;
            for (const line of lines) {
                const match = line.match(goalRegex);
                if (match) {
                    const time = match[1];
                    const timeValue = timeToMinutes(time);
                    const currentScore = match[2].split(':').map(Number);
                    const is7m = match[3].startsWith('7m');
                    const scorerInfo = match[5].trim();
                    const lastKnownScore = scoreProgression[scoreProgression.length - 1].score;
                    scoreProgression.push({ time, timeValue, score: currentScore });
                    let teamName = '';
                    const homeScoreIncreased = currentScore[0] > lastKnownScore[0];
                    const guestScoreIncreased = currentScore[1] > lastKnownScore[1];
                    if (homeScoreIncreased && !guestScoreIncreased) { teamName = homeTeam; } 
                    else if (guestScoreIncreased && !homeScoreIncreased) { teamName = guestTeam; } 
                    else { if (homeScoreIncreased) { teamName = homeTeam; } else if (guestScoreIncreased) { teamName = guestTeam; } }
                    if (teamName) {
                        let scorerName = '';
                        const pattern1 = scorerInfo.match(/(.*?)\s+\(\d+/); 
                        const pattern2 = scorerInfo.match(/Spieler (\d+)/); 
                        if (pattern1) { scorerName = pattern1[1].trim(); } 
                        else if (pattern2) { const playerNumber = parseInt(pattern2[1]); const map = teamName === homeTeam ? homePlayerMap : guestPlayerMap; scorerName = map[playerNumber] || `Spieler #${playerNumber}`; } 
                        else { scorerName = scorerInfo.split(',')[0].trim(); }
                        if (scorerName) { const teamScore = teamName === homeTeam ? currentScore[0] : currentScore[1]; goalEvents.push({ time, timeValue, scorer: scorerName, team: teamName, score: teamScore, is7m }); }
                    }
                }
            }
            return { goalEvents, scoreProgression };
        }

        function parseGameReport(text) {
            try {
                const cleanedText = cleanReport(text);
                const game = { rawText: text };
                const idMatch = cleanedText.match(/Spiel Nr\. (\d+)/);
                if (!idMatch) { console.error("Parsing Error: 'Spiel Nr.' not found."); return null; }
                game.id = idMatch[1];
                const dateMatch = cleanedText.match(/am (\d{2}\.\d{2}\.\d{2})/);
                if (!dateMatch) { console.error("Parsing Error: Date with 'am' not found."); return null; }
                game.date = dateMatch[1];
                const teamsMatch = cleanedText.match(/Heim - Gast (.*?) - (.*?)\n/);
                if (!teamsMatch) { console.error("Parsing Error: 'Heim - Gast' line not found."); return null; }
                game.homeTeam = teamsMatch[1].trim();
                game.guestTeam = teamsMatch[2].trim();
                const scoreMatch = cleanedText.match(/(?:Endstand|Ergebnis)\s*(?:\(.*\)\s*)?(\d+:\d+)/);
                if (!scoreMatch) { console.error("Parsing Error: 'Endstand' or 'Ergebnis' with score not found."); return null; }
                game.finalScore = scoreMatch[1];
                const rosterSplit = cleanedText.split('Mannschaftslisten');
                if (rosterSplit.length < 2) { console.error("Parsing Error: 'Mannschaftslisten' section not found."); return null; }
                const rosterSection = rosterSplit[1];
                const guestSplit = rosterSection.split('Gast:');
                if (guestSplit.length < 2) { console.error("Parsing Error: 'Gast:' section for guest roster not found."); return null; }
                const [homeRoster, guestRoster] = guestSplit;
                const homePlayers = parsePlayerList(homeRoster);
                const guestPlayers = parsePlayerList(guestRoster);
                game.players = [ ...homePlayers.map(p => ({...p, team: game.homeTeam})), ...guestPlayers.map(p => ({...p, team: game.guestTeam})) ];
                const homePlayerMap = Object.fromEntries(homePlayers.map(p => [p.number, p.name]));
                const guestPlayerMap = Object.fromEntries(guestPlayers.map(p => [p.number, p.name]));
                const logSection = cleanedText.split('Spielverlauf')[1];
                const { goalEvents, scoreProgression } = parseEventsFromLog(logSection, game.homeTeam, game.guestTeam, homePlayerMap, guestPlayerMap);
                game.goalEvents = goalEvents;
                game.scoreProgression = scoreProgression;
                return game;
            } catch (error) {
                console.error("An unexpected error occurred during parsing:", error);
                return null;
            }
        }

        // --- DATA HANDLING -> Firestore ---
        async function handleProcessAndSaveGame() {
            if (!isAuthReady || !gamesCollectionRef) {
                showNotification("Datenbank ist nicht bereit. Bitte warten.", "error");
                return;
            }
            const text = gameDataInput.value.trim();
            if (!text) {
                showNotification("Bitte Spieldaten einfügen.", "info");
                return;
            }
            inputStatus.innerHTML = `<p class="text-blue-600">Analysiere Daten...</p>`;
            const gameData = parseGameReport(text);
            if (!gameData) {
                inputStatus.innerHTML = `<p class="text-red-500">Fehler beim Auslesen der Daten. Bitte überprüfe das Format.</p>`;
                return;
            }
            gameData.rawText = formatRawTextForEditing(text);
            const isUpdating = allGames.some(g => g.id === gameData.id);
            if (isUpdating) {
                const existingGame = allGames.find(g => g.id === gameData.id);
                gameData.nameCorrections = existingGame.nameCorrections || {};
            }
            try {
                const gameDocRef = doc(gamesCollectionRef, gameData.id);
                await setDoc(gameDocRef, gameData, { merge: true });
                const successMessage = currentlyEditingGameId ? `Spiel ${gameData.id} erfolgreich aktualisiert!` : `Spiel ${gameData.id} erfolgreich hinzugefügt!`;
                showNotification(successMessage, 'success');
                inputStatus.innerHTML = '';
                resetToNewEntryMode();
                setTimeout(() => { switchView('archiv'); }, 1000);
            } catch (error) {
                console.error("Fehler beim Speichern in Firestore:", error);
                inputStatus.innerHTML = `<p class="text-red-500">Fehler beim Speichern der Daten. Bitte versuche es erneut.</p>`;
            }
        }

        async function deleteGame(gameId) {
            if (!isAuthReady || !gamesCollectionRef) {
                showNotification("Datenbank ist nicht bereit.", "error");
                return;
            }
            try {
                const gameDocRef = doc(gamesCollectionRef, gameId);
                await deleteDoc(gameDocRef);
                showNotification(`Spiel ${gameId} erfolgreich gelöscht.`, 'success');
            } catch (error) {
                console.error("Fehler beim Löschen aus Firestore:", error);
                showNotification("Das Spiel konnte nicht gelöscht werden.", 'error');
            }
        }
        
        function updateDynamicContent() {
            renderArchiveList();
            populateTeamSelector();
            populatePlayerSelector();
            populateH2hSelectors();
            renderStatistics();
            if (playerSelect.value) renderPlayerProfile(playerSelect.value, false);
            if (views.gameDetail.classList.contains('view-active') && currentlyEditingGameId) {
                const gameExists = allGames.some(g => g.id === currentlyEditingGameId);
                if (gameExists) { 
                    renderGameDetail(currentlyEditingGameId, false); 
                } 
                else { 
                    switchView('archiv'); 
                    currentlyEditingGameId = null;
                }
            }
        }

        // --- NAME CORRECTION ---
        function getCorrectedName(game, originalName) {
            return game.nameCorrections?.[originalName] || originalName;
        }

        function openNameCorrectionModal() {
            const game = allGames.find(g => g.id === currentlyEditingGameId);
            if (!game) return;
            nameCorrectionList.innerHTML = '';
            const createTeamList = (teamName, playersOfTeam) => {
                const uniquePlayers = Array.from(new Map(playersOfTeam.map(p => [p.name, p])).values());
                if (uniquePlayers.length > 0) {
                    const teamHeader = document.createElement('h4');
                    teamHeader.className = 'text-md font-bold text-gray-800 mt-4 first:mt-0';
                    teamHeader.textContent = getCorrectedName(game, teamName);
                    nameCorrectionList.appendChild(teamHeader);
                    uniquePlayers.forEach(player => {
                        const originalName = player.name;
                        const correctedName = getCorrectedName(game, originalName);
                        const div = document.createElement('div');
                        div.className = 'player-correction-item space-y-1 py-2 border-t first:border-t-0';
                        let buttonHtml = '';
                        if (teamName === SG_BUENDE_DUENNE && STANDARD_ROSTER_SGBD[player.number]) {
                            buttonHtml = `<button class="kadername-btn bg-blue-500 text-white text-xs px-2 py-1 rounded hover:bg-blue-600 ml-2" data-player-number="${player.number}">Kadername</button>`;
                        }
                        div.innerHTML = `
                            <div>
                                <label class="text-gray-600 font-medium truncate" title="${originalName}">${originalName}</label>
                                ${buttonHtml}
                            </div>
                            <input type="text" value="${correctedName}" data-original-name="${originalName}" class="p-2 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        `;
                        nameCorrectionList.appendChild(div);
                    });
                }
            };
            const homePlayers = game.players.filter(p => p.team === game.homeTeam);
            createTeamList(game.homeTeam, homePlayers);
            const guestPlayers = game.players.filter(p => p.team === game.guestTeam);
            createTeamList(game.guestTeam, guestPlayers);
            nameCorrectionModal.classList.add('flex');
        }

        function applyAllRosterNames() {
            const inputs = nameCorrectionList.querySelectorAll('input[data-original-name]');
            inputs.forEach(input => {
                const itemDiv = input.closest('.player-correction-item');
                const button = itemDiv.querySelector('.kadername-btn');
                if (button) {
                    const playerNumber = button.dataset.playerNumber;
                    const standardName = STANDARD_ROSTER_SGBD[playerNumber];
                    if (standardName) {
                        input.value = standardName;
                    }
                }
            });
        }

        async function saveNameCorrections() {
            if (!isAuthReady || !gamesCollectionRef) {
                showNotification("Datenbank ist nicht bereit.", "error");
                return;
            }
            const game = allGames.find(g => g.id === currentlyEditingGameId);
            if (!game) return;

            const newCorrections = { ...(game.nameCorrections || {}) };
            const inputs = nameCorrectionList.querySelectorAll('input[data-original-name]');
            inputs.forEach(input => {
                const originalName = input.dataset.originalName;
                const newName = input.value.trim();
                if (newName && newName !== originalName) { newCorrections[originalName] = newName; } 
                else if (!newName || newName === originalName) { delete newCorrections[originalName]; }
            });
            try {
                const gameDocRef = doc(gamesCollectionRef, game.id);
                await updateDoc(gameDocRef, { nameCorrections: newCorrections });
                nameCorrectionModal.classList.remove('flex');
                showNotification("Namen erfolgreich gespeichert.", 'success');
            } catch (error) {
                console.error("Fehler beim Speichern der Namenskorrekturen:", error);
                showNotification("Die Korrekturen konnten nicht gespeichert werden.", 'error');
            }
        }

        // --- IMPORT / EXPORT ---
        function exportGames() {
            if (allGames.length === 0) {
                showNotification("Keine Spiele zum Exportieren vorhanden.", "info");
                return;
            }
            const jsonString = JSON.stringify(allGames, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `handball_saison_analysator_export_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function importGames(event) {
            if (!isAuthReady || !gamesCollectionRef) {
                showNotification("Datenbank ist nicht bereit.", "error");
                return;
            }
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedGames = JSON.parse(e.target.result);
                    if (!Array.isArray(importedGames)) { throw new Error("Importierte Datei hat kein gültiges Format (Array erwartet)."); }
                    importStatus.innerHTML = `<p class="text-blue-600">Importiere ${importedGames.length} Spiele in die Datenbank...</p>`;
                    const batch = writeBatch(db);
                    importedGames.forEach(game => {
                        if (game.id) {
                            const docRef = doc(gamesCollectionRef, game.id.toString());
                            batch.set(docRef, game, { merge: true });
                        }
                    });
                    await batch.commit();
                    importStatus.innerHTML = `<p class="text-green-600">Import erfolgreich! ${importedGames.length} Spiele wurden in die Cloud geladen.</p>`;
                } catch (error) {
                    console.error("Import Error:", error);
                    importStatus.innerHTML = `<p class="text-red-500">Fehler beim Import: ${error.message}</p>`;
                } finally {
                    importFileInput.value = '';
                    setTimeout(() => { importStatus.innerHTML = '' }, 5000);
                }
            };
            reader.readAsText(file);
        }

        function exportDetailAsImage() {
            showNotification('Grafik wird erstellt...', 'info');
            const elementToCapture = document.getElementById('detail-content-graphical');
            html2canvas(elementToCapture, { 
                backgroundColor: '#ffffff',
                useCORS: true,
                onclone: (document) => {
                    // Make sure the clone has a white background for the export
                    document.getElementById('detail-content-graphical').style.backgroundColor = 'white';
                }
            }).then(canvas => {
                const link = document.createElement('a');
                const game = allGames.find(g => g.id === currentlyEditingGameId);
                const fileName = `Analyse_${game.homeTeam}_vs_${game.guestTeam}.png`;
                link.download = fileName;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(err => {
                console.error('oops, something went wrong!', err);
                showNotification('Fehler beim Erstellen der Grafik.', 'error');
            });
        }

        // --- RENDERING FUNCTIONS ---
        function renderArchiveList() {
            if (!isAuthReady) {
                gameArchiveList.innerHTML = `<p class="text-gray-500">Verbinde mit der Datenbank...</p>`;
                return;
            }
            
            const searchTerm = archiveSearchInput.value.toLowerCase();
            const filteredGames = allGames.filter(game => {
                if (!searchTerm) return true;
                const homeTeam = getCorrectedName(game, game.homeTeam).toLowerCase();
                const guestTeam = getCorrectedName(game, game.guestTeam).toLowerCase();
                return homeTeam.includes(searchTerm) || guestTeam.includes(searchTerm);
            });

            if (filteredGames.length === 0) {
                gameArchiveList.innerHTML = `<p class="text-gray-500">Keine Spiele gefunden.</p>`;
                return;
            }
            gameArchiveList.innerHTML = filteredGames.map(game => `
                <button data-game-id="${game.id}" class="game-entry-btn w-full text-left border border-gray-200 p-4 rounded-lg hover:bg-gray-50 hover:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                    <div class="flex justify-between items-center pointer-events-none">
                        <div>
                            <p class="font-bold text-lg">${getCorrectedName(game, game.homeTeam)} vs ${getCorrectedName(game, game.guestTeam)}</p>
                            <p class="text-sm text-gray-500">Datum: ${game.date} | ID: ${game.id}</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <p class="text-2xl font-bold text-indigo-600">${game.finalScore}</p>
                            <div data-game-id="${game.id}" class="delete-game-btn text-gray-400 hover:text-red-500 p-2 rounded-full hover:bg-red-100 pointer-events-auto" title="Spiel löschen">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </div>
                        </div>
                    </div>
                </button>
            `).join('');
        }
        
        const playerColors = {};
        const colorPalette = [ '#d62828', '#f77f00', '#0081a7', '#00afb9', '#8338ec', '#3a86ff', '#ff006e', '#e63946', '#2a9d8f', '#f4a261', '#e76f51', '#6a994e', '#a7c957', '#3d405b', '#d90429', '#023047', '#fb8500', '#219ebc', '#ffb703', '#7cb518' ];
        let colorIndex = 0;

        function getPlayerColor(playerName) {
            if (!playerColors[playerName]) {
                playerColors[playerName] = colorPalette[colorIndex % colorPalette.length];
                colorIndex++;
            }
            return playerColors[playerName];
        }

        function updateChartWithSelectedPlayers(game) {
            if (!scoreChart) return;
            scoreChart.data.datasets = scoreChart.data.datasets.filter(ds => ds.type !== 'scatter');
            selectedPlayers.forEach(playerName => {
                const playerEvents = (game.goalEvents || []).filter(event => getCorrectedName(game, event.scorer) === playerName);
                const dataPoints = playerEvents.map(event => ({ x: event.timeValue, y: event.score, is7m: event.is7m }));
                scoreChart.data.datasets.push({
                    type: 'scatter', label: playerName, data: dataPoints,
                    backgroundColor: getPlayerColor(playerName),
                    radius: dataPoints.map(e => e.is7m ? 10 : 8),
                    pointStyle: dataPoints.map(e => e.is7m ? 'triangle' : 'circle'),
                    hoverRadius: 12,
                });
            });
            scoreChart.update();
        }

        function calculateStreaks(game) {
            const streaks = [{ timeValue: 0, homeStreak: 0, guestStreak: 0 }];
            if (!game.scoreProgression || game.scoreProgression.length < 2) { return streaks; }
            let homeRun = 0; let guestRun = 0; let lastScore = [0, 0];
            for (let i = 1; i < game.scoreProgression.length; i++) {
                const entry = game.scoreProgression[i];
                const currentScore = entry.score;
                if (currentScore[0] > lastScore[0]) { homeRun++; guestRun = 0; } 
                else if (currentScore[1] > lastScore[1]) { guestRun++; homeRun = 0; }
                streaks.push({ timeValue: entry.timeValue, homeStreak: homeRun, guestStreak: -guestRun });
                lastScore = currentScore;
            }
            return streaks;
        }

        function renderScoringRunChart(game) {
            if (scoringRunChart) { scoringRunChart.destroy(); }
            const streakData = calculateStreaks(game);
            scoringRunChart = new Chart(scoringRunChartCanvas, {
                type: 'line', data: {
                    labels: streakData.map(s => s.timeValue),
                    datasets: [ {
                        label: getCorrectedName(game, game.homeTeam), data: streakData.map(s => s.homeStreak),
                        backgroundColor: 'rgba(79, 70, 229, 0.5)', borderColor: 'rgba(79, 70, 229, 1)',
                        stepped: true, fill: true, pointRadius: 0,
                    }, {
                        label: getCorrectedName(game, game.guestTeam), data: streakData.map(s => s.guestStreak),
                        backgroundColor: 'rgba(220, 38, 38, 0.5)', borderColor: 'rgba(220, 38, 38, 1)',
                        stepped: true, fill: true, pointRadius: 0,
                    } ] },
                options: { responsive: true, plugins: {
                    title: { display: true, text: 'Tor-Rhythmus (Läufe)' },
                    tooltip: { callbacks: {
                        title: function(context) {
                            const dp = context[0]; const min = Math.floor(dp.label); const sec = Math.round((dp.label - min) * 60);
                            return `Minute: ${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
                        },
                        label: function(context) {
                            const val = context.raw;
                            if (val > 0) return `${context.dataset.label}: ${val}:0 Lauf`;
                            if (val < 0) return `${context.dataset.label}: ${-val}:0 Lauf`;
                            return null;
                        } } } },
                scales: {
                    x: { type: 'linear', title: { display: true, text: 'Spielzeit (Minuten)' }, ticks: { stepSize: 5 } },
                    y: { title: { display: true, text: 'Anzahl Tore in Folge' }, ticks: { callback: v => Math.abs(v) } } } }
            });
        }

        function renderGameDetail(gameId, doSwitchView = true) {
            const game = allGames.find(g => g.id === gameId);
            if (!game) return;
            currentlyEditingGameId = gameId; 
            selectedPlayers = []; 
            
            gameDetailTitle.textContent = `${getCorrectedName(game, game.homeTeam)} vs ${getCorrectedName(game, game.guestTeam)}`;
            gameDetailSubtitle.textContent = `Endstand: ${game.finalScore} am ${game.date}`;

            populateGameNavigation(gameId);

            if (scoreChart) { scoreChart.destroy(); }
            const datasets = [ {
                    label: getCorrectedName(game, game.homeTeam), data: game.scoreProgression.map(p => ({x: p.timeValue, y: p.score[0]})),
                    borderColor: 'rgba(79, 70, 229, 0.8)', backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    tension: 0.1, fill: true, pointRadius: 0,
                }, {
                    label: getCorrectedName(game, game.guestTeam), data: game.scoreProgression.map(p => ({x: p.timeValue, y: p.score[1]})),
                    borderColor: 'rgba(220, 38, 38, 0.8)', backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    tension: 0.1, fill: true, pointRadius: 0,
                } ];
            scoreChart = new Chart(scoreChartCanvas, {
                type: 'line', data: { datasets },
                options: { responsive: true, plugins: {
                    legend: { position: 'top', labels: { filter: item => item.datasetIndex < 2 } },
                    title: { display: true, text: 'Spielverlauf' },
                    tooltip: { callbacks: {
                        title: function(context) {
                            const dp = context[0].raw; const min = Math.floor(dp.x); const sec = Math.round((dp.x - min) * 60);
                            return `Minute: ${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
                        },
                        label: function(context) {
                            if (context.dataset.type === 'scatter') { const goalType = context.raw.is7m ? " (7m)" : ""; return `${context.dataset.label}: Tor zum ${context.raw.y}${goalType}`; }
                            return `${context.dataset.label}: ${context.formattedValue}`;
                        } } } },
                scales: {
                    x: { type: 'linear', title: { display: true, text: 'Spielzeit (Minuten)' }, ticks: { stepSize: 5 } },
                    y: { beginAtZero: true, title: { display: true, text: 'Tore' }, ticks: { stepSize: 1 } } } }
            });
            const goalCounts = {};
            (game.goalEvents || []).forEach(event => {
                const correctedScorer = getCorrectedName(game, event.scorer);
                if (!goalCounts[correctedScorer]) { goalCounts[correctedScorer] = { name: correctedScorer, team: event.team, count: 0 }; }
                goalCounts[correctedScorer].count++;
            });
            const homeScorers = Object.values(goalCounts).filter(p => p.team === game.homeTeam).sort((a,b) => b.count - a.count);
            const guestScorers = Object.values(goalCounts).filter(p => p.team === game.guestTeam).sort((a,b) => b.count - a.count);
            let playerListHtml = '';
            if (homeScorers.length > 0) {
                playerListHtml += `<h4 class="font-semibold text-sm text-gray-800 mb-1">${getCorrectedName(game, game.homeTeam)}</h4>`;
                playerListHtml += homeScorers.map(scorer => `<button class="player-goal-btn w-full text-left p-2 rounded-md hover:bg-gray-200 transition" data-player-name="${scorer.name}"><span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: ${getPlayerColor(scorer.name)}"></span>${scorer.name} <span class="text-gray-500 font-medium">(${scorer.count})</span></button>`).join('');
            }
            if (guestScorers.length > 0) {
                playerListHtml += `<h4 class="font-semibold text-sm text-gray-800 mt-3 mb-1">${getCorrectedName(game, game.guestTeam)}</h4>`;
                playerListHtml += guestScorers.map(scorer => `<button class="player-goal-btn w-full text-left p-2 rounded-md hover:bg-gray-200 transition" data-player-name="${scorer.name}"><span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: ${getPlayerColor(scorer.name)}"></span>${scorer.name} <span class="text-gray-500 font-medium">(${scorer.count})</span></button>`).join('');
            }
            playerGoalList.innerHTML = playerListHtml || '<p class="text-sm text-gray-500">Keine Tordaten im Spielverlauf gefunden.</p>';
            renderScoringRunChart(game);
            
            renderTabularDetailContent(game);

            if (doSwitchView) {
                switchView('gameDetail');
            }
            switchDetailView('graphical');
        }

        function renderTabularDetailContent(game) {
            let contentHtml = '';
            const renderPlayerTable = (teamName, players) => {
                let tableHtml = `<div class="overflow-x-auto"><h3 class="text-xl font-bold mb-2 text-indigo-700">${getCorrectedName(game, teamName)}</h3><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Spieler</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tore</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">7m</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Verwarnungen">V</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="2-Minuten-Strafen">2'</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                players.forEach(p => {
                    tableHtml += `<tr><td class="px-4 py-4 whitespace-nowrap font-medium clickable-player" data-player-name="${getCorrectedName(game, p.name)}">${getCorrectedName(game, p.name)}</td><td class="px-4 py-4 whitespace-nowrap">${p.goals}</td><td class="px-4 py-4 whitespace-nowrap">${p.sevenMeterGoals}/${p.sevenMetersAttempted}</td><td class="px-4 py-4 whitespace-nowrap">${p.warnings}</td><td class="px-4 py-4 whitespace-nowrap">${p.suspensions}</td></tr>`;
                });
                tableHtml += `</tbody></table></div>`;
                return tableHtml;
            };
            contentHtml += `<h2 class="text-2xl font-bold mb-4">Spielerstatistiken</h2>`;
            const homePlayers = game.players.filter(p => p.team === game.homeTeam);
            const guestPlayers = game.players.filter(p => p.team === game.guestTeam);
            contentHtml += '<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">';
            contentHtml += renderPlayerTable(game.homeTeam, homePlayers);
            contentHtml += renderPlayerTable(game.guestTeam, guestPlayers);
            contentHtml += '</div>';
            contentHtml += `<h2 class="text-2xl font-bold mt-8 mb-4">Spielverlauf</h2>`;
            contentHtml += `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Zeit</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Spielstand</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Torschütze</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
            let goalEventIndex = 0;
            game.scoreProgression.forEach((entry, index) => {
                if (index === 0) return; 
                let scorerName = '';
                if (game.goalEvents && goalEventIndex < game.goalEvents.length && Math.abs(game.goalEvents[goalEventIndex].timeValue - entry.timeValue) < 0.02) {
                    scorerName = getCorrectedName(game, game.goalEvents[goalEventIndex].scorer);
                    goalEventIndex++;
                }
                contentHtml += `<tr><td class="px-4 py-4 whitespace-nowrap">${entry.time}</td><td class="px-4 py-4 whitespace-nowrap font-bold">${entry.score.join(' : ')}</td><td class="px-4 py-4 whitespace-nowrap">${scorerName}</td></tr>`;
            });
            contentHtml += `</tbody></table></div>`;
            tabularContentContainer.innerHTML = contentHtml;
        }

        function populateTeamSelector() {
            const teams = new Set();
            allGames.forEach(game => { 
                teams.add(getCorrectedName(game, game.homeTeam)); 
                teams.add(getCorrectedName(game, game.guestTeam)); 
            });
            const sortedTeams = [...teams].sort((a, b) => a.localeCompare(b));
            const currentSelection = teamSelect.value;
            teamSelect.innerHTML = '<option value="">-- Team auswählen --</option>';
            sortedTeams.forEach(team => { teamSelect.innerHTML += `<option value="${team}">${team}</option>`; });
            if (sortedTeams.includes(currentSelection)) { teamSelect.value = currentSelection; }
        }

        function renderStatistics() {
            const selectedTeam = teamSelect.value;
            if (!selectedTeam) {
                statsContainer.innerHTML = '';
                statsPlaceholder.style.display = 'block';
                return;
            }
            statsPlaceholder.style.display = 'none';
            const teamGames = allGames.filter(g => getCorrectedName(g, g.homeTeam) === selectedTeam || getCorrectedName(g, g.guestTeam) === selectedTeam);
            if (teamGames.length === 0) {
                statsContainer.innerHTML = `<p class="text-gray-500">Für dieses Team wurden keine Spiele gefunden.</p>`;
                return;
            }
            let wins = 0, losses = 0, draws = 0, goalsScored = 0, goalsConceded = 0;
            teamGames.forEach(game => {
                const [homeG, awayG] = game.finalScore.split(':').map(Number);
                if (getCorrectedName(game, game.homeTeam) === selectedTeam) {
                    goalsScored += homeG; goalsConceded += awayG;
                    if (homeG > awayG) wins++; else if (homeG < awayG) losses++; else draws++;
                } else {
                    goalsScored += awayG; goalsConceded += homeG;
                    if (awayG > homeG) wins++; else if (awayG < homeG) losses++; else draws++;
                }
            });

            const totalGames = teamGames.length;
            const winPercentage = totalGames > 0 ? (wins / totalGames) * 100 : 0;
            const drawPercentage = totalGames > 0 ? (draws / totalGames) * 100 : 0;
            const lossPercentage = totalGames > 0 ? (losses / totalGames) * 100 : 0;

            const playerAggregatedStats = {};
            let total7mGoals = 0;
            let total7mAttempts = 0;
            teamGames.forEach(game => {
                (game.players || []).forEach(p => {
                    const correctedTeamName = getCorrectedName(game, p.team);
                    if (correctedTeamName === selectedTeam) {
                        const correctedPlayerName = getCorrectedName(game, p.name);
                        if (!playerAggregatedStats[correctedPlayerName]) {
                            playerAggregatedStats[correctedPlayerName] = { name: correctedPlayerName, games: 0, goals: 0, sevenMeterGoals: 0, sevenMetersAttempted: 0, warnings: 0, suspensions: 0 };
                        }
                        const playerInGame = playerAggregatedStats[correctedPlayerName];
                        playerInGame.games++;
                        playerInGame.goals += p.goals;
                        playerInGame.sevenMeterGoals += p.sevenMeterGoals;
                        playerInGame.sevenMetersAttempted += p.sevenMetersAttempted;
                        playerInGame.warnings += p.warnings;
                        playerInGame.suspensions += p.suspensions;
                        total7mGoals += p.sevenMeterGoals;
                        total7mAttempts += p.sevenMetersAttempted;
                    }
                });
            });

            const sevenMeterQuote = total7mAttempts > 0 ? ((total7mGoals / total7mAttempts) * 100).toFixed(1) : 0;

            const sortedPlayers = Object.values(playerAggregatedStats).sort((a,b) => b.goals - a.goals);
            statsContainer.innerHTML = `
                <div class="bg-gray-50 p-6 rounded-lg border">
                    <h3 class="text-xl font-bold mb-4 text-indigo-700">Team-Übersicht: ${selectedTeam}</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="bg-white p-4 rounded-lg shadow"><p class="text-3xl font-bold">${totalGames}</p><p class="text-sm text-gray-500">Spiele</p></div>
                        <div class="bg-white p-4 rounded-lg shadow"><p class="text-3xl font-bold text-green-600">${wins}</p><p class="text-sm text-gray-500">Siege</p></div>
                        <div class="bg-white p-4 rounded-lg shadow"><p class="text-3xl font-bold text-red-600">${losses}</p><p class="text-sm text-gray-500">Niederlagen</p></div>
                        <div class="bg-white p-4 rounded-lg shadow"><p class="text-3xl font-bold text-yellow-600">${draws}</p><p class="text-sm text-gray-500">Unentschieden</p></div>
                        <div class="bg-white p-4 rounded-lg shadow col-span-2"><p class="text-3xl font-bold">${goalsScored} : ${goalsConceded}</p><p class="text-sm text-gray-500">Torverhältnis</p></div>
                        <div class="bg-white p-4 rounded-lg shadow col-span-2"><p class="text-3xl font-bold">${totalGames > 0 ? (goalsScored / totalGames).toFixed(2) : '0.00'}</p><p class="text-sm text-gray-500">Tore pro Spiel</p></div>
                    </div>
                    <div class="mt-6">
                        <h4 class="font-semibold mb-2">Sieg-Verhältnis</h4>
                        <div class="w-full bg-gray-200 rounded-full h-6 flex overflow-hidden">
                            <div class="bg-green-500 h-full text-white text-xs flex items-center justify-center" style="width: ${winPercentage}%" title="Siege: ${wins}">${Math.round(winPercentage)}%</div>
                            <div class="bg-yellow-500 h-full text-white text-xs flex items-center justify-center" style="width: ${drawPercentage}%" title="Unentschieden: ${draws}">${Math.round(drawPercentage)}%</div>
                            <div class="bg-red-500 h-full text-white text-xs flex items-center justify-center" style="width: ${lossPercentage}%" title="Niederlagen: ${losses}">${Math.round(lossPercentage)}%</div>
                        </div>
                    </div>
                     <div class="mt-6">
                        <h4 class="font-semibold mb-2">7-Meter Quote (${total7mGoals}/${total7mAttempts})</h4>
                        <div class="w-full bg-gray-200 rounded-full h-6">
                            <div class="bg-blue-500 h-full rounded-full text-white text-xs flex items-center justify-center" style="width: ${sevenMeterQuote}%">${sevenMeterQuote}%</div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 p-6 rounded-lg border">
                    <h3 class="text-xl font-bold mb-4 text-indigo-700">Spieler-Statistiken</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Spieler</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Spiele</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tore</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tore / Spiel</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">7m Quote</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Verwarnungen">Verw.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="2-Minuten-Strafen">2-Min</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${sortedPlayers.map(p => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap font-medium clickable-player" data-player-name="${p.name}">${p.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${p.games}</td>
                                        <td class="px-6 py-4 whitespace-nowrap font-bold">${p.goals}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${p.games > 0 ? (p.goals / p.games).toFixed(2) : '0.00'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${p.sevenMeterGoals} / ${p.sevenMetersAttempted}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${p.warnings}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${p.suspensions}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
        }
        
        function populatePlayerSelector() {
            const playerNames = new Set();
            allGames.forEach(game => {
                game.players.forEach(player => {
                    playerNames.add(getCorrectedName(game, player.name));
                });
            });
            const sortedPlayers = [...playerNames].sort((a, b) => a.localeCompare(b));
            const currentSelection = playerSelect.value;
            playerSelect.innerHTML = '<option value="">-- Spieler auswählen --</option>';
            sortedPlayers.forEach(name => {
                playerSelect.innerHTML += `<option value="${name}">${name}</option>`;
            });
            if (sortedPlayers.includes(currentSelection)) {
                playerSelect.value = currentSelection;
            }
        }

        function renderPlayerProfile(playerName, doSwitchView = false) {
            if (!playerName) {
                playerProfileContainer.innerHTML = '';
                playerProfilePlaceholder.style.display = 'block';
                return;
            }
            
            if (doSwitchView) {
                playerSelect.value = playerName;
                switchView('spieler');
            }

            playerProfilePlaceholder.style.display = 'none';

            const stats = { games: 0, goals: 0, sevenMeterGoals: 0, sevenMetersAttempted: 0, warnings: 0, suspensions: 0 };
            const gamesWithPlayer = [];

            allGames.forEach(game => {
                let playerInGame = null;
                game.players.forEach(p => {
                    if (getCorrectedName(game, p.name) === playerName) {
                        playerInGame = p;
                    }
                });

                if (playerInGame) {
                    stats.games++;
                    stats.goals += playerInGame.goals;
                    stats.sevenMeterGoals += playerInGame.sevenMeterGoals;
                    stats.sevenMetersAttempted += playerInGame.sevenMetersAttempted;
                    stats.warnings += playerInGame.warnings;
                    stats.suspensions += playerInGame.suspensions;
                    gamesWithPlayer.push({
                        date: game.date,
                        opponent: getCorrectedName(game, playerInGame.team) === getCorrectedName(game, game.homeTeam) ? getCorrectedName(game, game.guestTeam) : getCorrectedName(game, game.homeTeam),
                        goals: playerInGame.goals
                    });
                }
            });

            const goalsPerGame = stats.games > 0 ? (stats.goals / stats.games).toFixed(2) : '0.00';
            const sevenMeterQuote = stats.sevenMetersAttempted > 0 ? ((stats.sevenMeterGoals / stats.sevenMetersAttempted) * 100).toFixed(1) : '0';

            let html = `
                <div class="bg-gray-50 p-6 rounded-lg border">
                    <h3 class="text-xl font-bold mb-4 text-indigo-700">${playerName}</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-center">
                        <div class="bg-white p-4 rounded-lg shadow"><p class="text-3xl font-bold">${stats.games}</p><p class="text-sm text-gray-500">Spiele</p></div>
                        <div class="bg-white p-4 rounded-lg shadow"><p class="text-3xl font-bold">${stats.goals}</p><p class="text-sm text-gray-500">Tore</p></div>
                        <div class="bg-white p-4 rounded-lg shadow"><p class="text-3xl font-bold">${goalsPerGame}</p><p class="text-sm text-gray-500">Tore/Spiel</p></div>
                        <div class="bg-white p-4 rounded-lg shadow"><p class="text-3xl font-bold">${sevenMeterQuote}%</p><p class="text-sm text-gray-500">7m Quote</p></div>
                        <div class="bg-white p-4 rounded-lg shadow"><p class="text-3xl font-bold">${stats.warnings}</p><p class="text-sm text-gray-500">Verwarn.</p></div>
                        <div class="bg-white p-4 rounded-lg shadow"><p class="text-3xl font-bold">${stats.suspensions}</p><p class="text-sm text-gray-500">2-Min</p></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8">
                    <div class="bg-gray-50 p-6 rounded-lg border">
                        <h3 class="text-xl font-bold mb-4 text-indigo-700">Tor-Verlauf</h3>
                        <canvas id="player-profile-chart"></canvas>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-lg border">
                         <h3 class="text-xl font-bold mb-4 text-indigo-700">Spieleliste</h3>
                         <div class="overflow-y-auto max-h-96">
                            <table class="min-w-full">
                                <thead class="bg-gray-200 sticky top-0"><tr><th class="px-4 py-2 text-left">Datum</th><th class="px-4 py-2 text-left">Gegner</th><th class="px-4 py-2 text-left">Tore</th></tr></thead>
                                <tbody class="divide-y">
                                ${gamesWithPlayer.map(g => `<tr><td class="px-4 py-2">${g.date}</td><td class="px-4 py-2">${g.opponent}</td><td class="px-4 py-2 font-bold">${g.goals}</td></tr>`).join('')}
                                </tbody>
                            </table>
                         </div>
                    </div>
                </div>
            `;
            playerProfileContainer.innerHTML = html;

            if (playerProfileChart) playerProfileChart.destroy();
            const chartCanvas = document.getElementById('player-profile-chart');
            playerProfileChart = new Chart(chartCanvas, {
                type: 'line',
                data: {
                    labels: gamesWithPlayer.map((g, i) => `Spiel ${i+1}`),
                    datasets: [{
                        label: 'Tore pro Spiel',
                        data: gamesWithPlayer.map(g => g.goals),
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

        function populateH2hSelectors() {
            const teams = new Set();
            allGames.forEach(game => { 
                teams.add(getCorrectedName(game, game.homeTeam)); 
                teams.add(getCorrectedName(game, game.guestTeam)); 
            });
            const sortedTeams = [...teams].sort((a, b) => a.localeCompare(b));
            
            const currentTeam1 = h2hTeam1Select.value;
            const currentTeam2 = h2hTeam2Select.value;

            h2hTeam1Select.innerHTML = '<option value="">-- Team 1 --</option>';
            h2hTeam2Select.innerHTML = '<option value="">-- Team 2 --</option>';

            sortedTeams.forEach(team => {
                h2hTeam1Select.innerHTML += `<option value="${team}">${team}</option>`;
                h2hTeam2Select.innerHTML += `<option value="${team}">${team}</option>`;
            });

            if(sortedTeams.includes(currentTeam1)) h2hTeam1Select.value = currentTeam1;
            if(sortedTeams.includes(currentTeam2)) h2hTeam2Select.value = currentTeam2;
        }

        function renderH2hComparison() {
            const team1 = h2hTeam1Select.value;
            const team2 = h2hTeam2Select.value;

            if (!team1 || !team2) {
                h2hResultsContainer.innerHTML = `<p class="text-center text-gray-500">Bitte zwei Teams auswählen.</p>`;
                return;
            }
            if (team1 === team2) {
                h2hResultsContainer.innerHTML = `<p class="text-center text-gray-500">Bitte zwei unterschiedliche Teams auswählen.</p>`;
                return;
            }

            const matchups = allGames.filter(game => {
                const home = getCorrectedName(game, game.homeTeam);
                const guest = getCorrectedName(game, game.guestTeam);
                return (home === team1 && guest === team2) || (home === team2 && guest === team1);
            });

            if (matchups.length === 0) {
                h2hResultsContainer.innerHTML = `<p class="text-center text-gray-500">Keine direkten Begegnungen zwischen diesen Teams gefunden.</p>`;
                return;
            }

            let team1Wins = 0, team2Wins = 0, draws = 0;
            let team1Goals = 0, team2Goals = 0;

            matchups.forEach(game => {
                const [homeScore, guestScore] = game.finalScore.split(':').map(Number);
                const homeTeam = getCorrectedName(game, game.homeTeam);
                
                if (homeTeam === team1) {
                    team1Goals += homeScore;
                    team2Goals += guestScore;
                    if (homeScore > guestScore) team1Wins++;
                    else if (guestScore > homeScore) team2Wins++;
                    else draws++;
                } else { // homeTeam is team2
                    team2Goals += homeScore;
                    team1Goals += guestScore;
                    if (guestScore > homeScore) team1Wins++;
                    else if (homeScore > guestScore) team2Wins++;
                    else draws++;
                }
            });

            const avgGoals1 = (team1Goals / matchups.length).toFixed(2);
            const avgGoals2 = (team2Goals / matchups.length).toFixed(2);

            let html = `
                <div class="text-center bg-gray-50 p-6 rounded-lg">
                    <h3 class="text-2xl font-bold">${team1} vs ${team2}</h3>
                    <div class="mt-4 grid grid-cols-3 gap-4">
                        <div>
                            <p class="text-4xl font-bold text-green-600">${team1Wins}</p>
                            <p class="text-sm text-gray-600">Siege ${team1}</p>
                        </div>
                        <div>
                            <p class="text-4xl font-bold text-yellow-600">${draws}</p>
                            <p class="text-sm text-gray-600">Unentschieden</p>
                        </div>
                        <div>
                            <p class="text-4xl font-bold text-green-600">${team2Wins}</p>
                            <p class="text-sm text-gray-600">Siege ${team2}</p>
                        </div>
                    </div>
                     <div class="mt-4 grid grid-cols-2 gap-4 border-t pt-4">
                        <div><p class="text-xl font-bold">${avgGoals1}</p><p>Ø Tore ${team1}</p></div>
                        <div><p class="text-xl font-bold">${avgGoals2}</p><p>Ø Tore ${team2}</p></div>
                    </div>
                </div>
                <div class="mt-6">
                    <h4 class="text-lg font-semibold mb-2">Spiel-Historie</h4>
                    <ul class="space-y-2">
                        ${matchups.map(game => `
                            <li class="p-3 bg-white border rounded-lg flex justify-between items-center">
                                <span>${game.date}</span>
                                <span>${getCorrectedName(game, game.homeTeam)} - ${getCorrectedName(game, game.guestTeam)}</span>
                                <span class="font-bold text-lg">${game.finalScore}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
            h2hResultsContainer.innerHTML = html;
        }

        // --- Game Navigation Functions ---
        function populateGameNavigation(gameId) {
            gameNavSelect.innerHTML = '';
            allGames.forEach(game => {
                const option = document.createElement('option');
                option.value = game.id;
                option.textContent = `${game.date} - ${getCorrectedName(game, game.homeTeam)} vs ${getCorrectedName(game, game.guestTeam)}`;
                option.selected = game.id === gameId;
                gameNavSelect.appendChild(option);
            });

            const currentIndex = allGames.findIndex(g => g.id === gameId);
            prevGameBtn.disabled = currentIndex === 0;
            nextGameBtn.disabled = currentIndex === allGames.length - 1;
        }

        function navigateToPreviousGame() {
            const currentIndex = allGames.findIndex(g => g.id === currentlyEditingGameId);
            if (currentIndex > 0) {
                renderGameDetail(allGames[currentIndex - 1].id);
            }
        }

        function navigateToNextGame() {
            const currentIndex = allGames.findIndex(g => g.id === currentlyEditingGameId);
            if (currentIndex < allGames.length - 1) {
                renderGameDetail(allGames[currentIndex + 1].id);
            }
        }

        // --- Firebase Real-time Listener ---
        function listenForGames() {
            if (unsubscribeFromGames) unsubscribeFromGames();
            if (!gamesCollectionRef) return;
            
            unsubscribeFromGames = onSnapshot(gamesCollectionRef, snapshot => {
                const gamesFromDb = [];
                snapshot.forEach(doc => gamesFromDb.push(doc.data()));
                
                allGames = gamesFromDb.sort((a, b) => {
                    const dateA = new Date(a.date.split('.').reverse().join('-')).getTime();
                    const dateB = new Date(b.date.split('.').reverse().join('-')).getTime();
                    return dateA - dateB;
                });
                
                console.log('Daten aus Firestore geladen/aktualisiert:', allGames.length, 'Spiele');
                updateDynamicContent();
            }, error => {
                console.error("Fehler beim Laden der Spiele aus Firestore:", error);
                gameArchiveList.innerHTML = `<p class="text-red-500 p-4">Fehler beim Verbinden mit der Datenbank.</p>`;
            });
        }

        // --- STARTUP ---
        async function initializeAppAndAuth() {
            console.log("DEBUG: Starting Firebase initialization...");
            const firebaseConfig = {
                apiKey: "AIzaSyBzvp7Gor7qzDn78QoVEHU-vwG7imY4xKw",
                authDomain: "sgbdmb2425.firebaseapp.com",
                projectId: "sgbdmb2425",
                storageBucket: "sgbdmb2425.appspot.com",
                messagingSenderId: "132227886986",
                appId: "1:132227886986:web:0499501f444fdc10b12273",
                measurementId: "G-9NKRXVDLBV"
            };
            
            appId = firebaseConfig.appId;
            console.log("DEBUG: Using Firebase config:", firebaseConfig);

            try {
                app = initializeApp(firebaseConfig);
                console.log("DEBUG: Firebase App initialized successfully.");

                db = getFirestore(app);
                console.log("DEBUG: Firestore instance created.");

                auth = getAuth(app);
                console.log("DEBUG: Auth instance created.");

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("DEBUG: Auth state changed: User is signed in.", user.uid);
                        userId = user.uid;
                        gamesCollectionRef = collection(db, 'games');
                        isAuthReady = true;
                        connectionStatusDot.className = 'w-3 h-3 rounded-full status-dot-connected';
                        connectionStatusText.textContent = 'Verbunden';
                        listenForGames(); 
                    } else {
                        console.log("DEBUG: Auth state changed: User is signed out.");
                        isAuthReady = false;
                        userId = null;
                        if(unsubscribeFromGames) unsubscribeFromGames();
                        allGames = [];
                        connectionStatusDot.className = 'w-3 h-3 rounded-full status-dot-disconnected';
                        connectionStatusText.textContent = 'Nicht verbunden';
                        updateDynamicContent();
                    }
                });
                
                console.log("DEBUG: Attempting to sign in anonymously...");
                await signInAnonymously(auth);
                console.log("DEBUG: signInAnonymously completed.");

            } catch (error) {
                console.error("DEBUG: Error during Firebase initialization:", error);
                gameArchiveList.innerHTML = `<p class="text-red-500 p-4">Fehler bei der Initialisierung von Firebase. Prüfen Sie die Konfigurationsdaten und die Konsolenausgabe.</p>`;
                connectionStatusDot.className = 'w-3 h-3 rounded-full status-dot-disconnected';
                connectionStatusText.textContent = 'Initialisierungsfehler';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupUI();
            initializeAppAndAuth();
        });

    </script>

</body>
</html>

